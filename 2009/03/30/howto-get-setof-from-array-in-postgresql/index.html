<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="keywords" content="coding, howto, sql, admin, postgresql">
        <meta name="description" content="The use of so called ‘procedural languages’ in PostgreSQL allows the user to write user-defined functions in other languages than SQL or C. Since every query is sent to the server, the database server has to know how to interpret and handle function statements. As the PostgreSQL documentation describes, the ...">
        <title>HowTo: Get SETOF from Array in PostgreSQL - blog.dornea.nu</title>
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
        <link rel="stylesheet" href="/css/ipython.min.css" type="text/css" />
        <link rel="stylesheet" href="http://blog.dornea.nu/theme/css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="http://blog.dornea.nu/theme/font-icons/style.min.css" type="text/css" />
        <link rel="stylesheet" href="http://blog.dornea.nu/theme/css/niu2.min.css" type="text/css" />
        <link rel="stylesheet" href="/css/custom.css" type="text/css" />
		
        
        <link rel="canonical" href="http://blog.dornea.nu/2009/03/30/howto-get-setof-from-array-in-postgresql" />
        <script type="text/javascript">window.onload=function(){};</script>
        <!--[if lt IE 9]>
            <script src="http://blog.dornea.nu/theme/js/html5shiv.js"></script>
            <script src="http://blog.dornea.nu/theme/js/respond.min.js"></script>
        <![endif]-->
    </head>
    <body> 
        <div id="body-header">
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="col-md-12">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="http://blog.dornea.nu">
                            <i class="icon-home"></i>blog.dornea.nu
                        </a>
                    </div>
                    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                        <ul class="nav navbar-nav">
                            <li><a href="http://dornea.nu" title="about">
                                <i class="icon-user"></i>about</a>
                            </li>
                            <li><a href="/archives.html" title="archives">
                                <i class="icon-archive"></i>archives</a>
                            </li>
                            <li><a href="/tags.html" title="tags">
                                <i class="icon-tag"></i>tags</a>
                            </li>
                            <li><a href="/feeds/rss.xml" title="feeds">
                                <i class="icon-rss"></i>feeds</a>
                            </li>
                        <!-- category dropdown list -->
                        <li class="dropdown">
                           <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="icon-folder-open"></i>category<b class="caret"></b>
                           </a>
                           <ul class="dropdown-menu">
                               <li><a href="http://blog.dornea.nu/category/blog">
                                      <i class="icon-pencil"></i>blog
                                      (154)</a></li>
                               <li><a href="http://blog.dornea.nu/category/notes">
                                      <i class="icon-book"></i>notes
                                      (8)</a></li>
                           </ul>
                        </li>
                        <!--  self defined dropdown list -->
                        </ul>
                        
                        <!-- right nav bar -->
                        <ul class="nav navbar-nav navbar-right">
                        <!-- google custom search -->
                        <li>
                        <div id="niu2-cse-wrapper">
                            <div id="niu2-cse-header-box" class="navbar-form navbar-nav">
                                <form action="http://google.com/cse">
                                    <input type="hidden" name="cx" value="008508447409818574933:pxyxuhrgnxi" />
                                    <input type="hidden" name="ie" value="UTF-8" />
                                    <div class="form-group">
                                        <input id="niu2-cse-search-input" class="niu2-cse-header form-control" 
                                            type="text" name="q" 
                                            placeholder="Press enter to search ..."/>
                                    </div>
                                </form>
                           </div>
                           <div id="niu2-cse-ctrl-box" class="navbar-nav">
                            <i id="niu2-cse-search-image" class="icon-search navbar-nav"></i><span id="niu2-cse-search-text">Search</span>
                           </div>
                       </div>
                       </li>
                       </ul>
                    </nav>
                </div>
            </div>
<style>
    #banner{
        background-image:url("http://blog.dornea.nu//images/header.jpg");
    }   
</style>

<div id="banner">
    <div class="container">
        <div class="copy">
            <h2>blog.dornea.nu</h2>
                <p class="intro">Hack, code and drink some țuică. Personal blog of Victor Dorneanu.</p>
        </div>
    </div>
</div>
            <!-- End Banner -->
        </div>

        <div id="body-content">
            <div class="col-md-8 col-md-offset-2">
                <h1 id="content-heading">HowTo: Get SETOF from Array in PostgreSQL</h1>
            </div>
            <div id="niu2-left-container" class="col-md-6 col-md-offset-2 with-right-border">
                <div id="niu2-main-content">
                    <p>The use of so called ‘procedural languages’ in PostgreSQL allows the user to write user-defined functions in other languages than SQL or C. Since every query is sent to the server, the database server has to know how to interpret and handle function statements. As the PostgreSQL documentation describes, the function handler itself is a C language function compiled into a shared object and loaded on demand. All you have to do is to install the ‘language’ into your database. Besides that you’ll have to install the pre-compiled shared objects on your system. On my system (Debian 5.0) I had to install the ‘postgresql-plperl’ package. Afterwars I connected to the database and typed:<!--more--></p>
<pre class="brush: sql">CREATE FUNCTION plpgsql_call_handler ()
   RETURNS OPAQUE
   AS '/usr/lib/postgresql/8.3/lib/plpgsql.so'
LANGUAGE 'C';</pre>
<p>Of course you’ll have to look up for the right file path in order to work. Finally I was able to use the language ‘plpgsql’ in my functions. If you need help installing languages just check out the PostgreSQL <a href="http://www.postgresql.org/docs/8.3/static/plpgsql.html">documentation</a> (it helped me too).</p>
<h2 id="fcc5130196975f3e8ee1dde598a0600b">0×1 Polymorphic types</h2>
<p>When speaking of polymorphism in PostgreSQL, we actually refer to the polymorphic functions. So what’s the difference between a polymorphic type and a polymorphic function? They’re related to each other. In fact every function declared to use polymorphic types is called as a polymorphic function. These types (pseudo-types) are ‘anyelement’ and ‘anyarray’. So when arguments of these types are passed to a function, it can handle with different data types. Imagine a function called ‘equal’ that compares two arguments and returns a boolean:</p>
<pre class="brush: sql">CREATE or REPLACE FUNCTION equal (anyelement,anyelement)
  RETURNS boolean AS
  $$
      ...
      IF $1 == $2 THEN
          return TRUE;
      ELSE
          return FALSE;
      END IF;
  $$
LANGUAGE 'sql';</pre>
<p>‘equal’ will take 2 input values of the SAME data type. Otherwise how could you e.g. compare a string to an integer? Read <a href="http://www.postgresql.org/docs/current/static/extend-type-system.html">more</a>.</p>
<h2 id="d98ccf21b89cc65b3ea9286fd7ec1509">0×2 Getting started</h2>
<p>For this HowTo’s purpose we’ll use following employees table:</p>
<pre class="brush: sql">create table t_employee
(
        ID integer NOT NULL,
        name text,
        salary real, 
        start_date date,
        city text,
        CONSTRAINT primkey_ID PRIMARY KEY (ID)

) WITH (OIDS=FALSE);</pre>
<p>Then we insert some new data into the table:</p>
<pre class="brush: sql">INSERT INTO t_employee(ID,name,salary,start_date,city) 
   VALUES (1,'Peter','2100','2003-06-19','Stuttgart');
INSERT INTO t_employee(ID,name,salary,start_date,city) 
   VALUES (2,'Peter','2100','2003-06-19','Stuttgart');
INSERT INTO t_employee(ID,name,salary,start_date,city) 
   VALUES (3,'Marc','1560','2001-02-25','Mannheim');
INSERT INTO t_employee(ID,name,salary,start_date,city) 
   VALUES (4,'Stefan','1100','2008-03-14','Hamburg');
INSERT INTO t_employee(ID,name,salary,start_date,city) 
   VALUES (5,'Gerd','900','2004-06-24','Hannover');</pre>
<p>‘t_employee’ will now contain:</p>
<pre class="brush: sql">select * from t_employee;

 id |  name  | salary | start_date |   city    
----+--------+--------+------------+-----------
  1 | John   |   1100 | 2002-05-01 | Berlin
  2 | Peter  |   2100 | 2003-06-19 | Stuttgart
  3 | Marc   |   1560 | 2001-02-25 | Mannheim
  4 | Stefan |   1100 | 2008-03-14 | Hamburg
  5 | Gerd   |    900 | 2004-06-24 | Hannover
(5 rows)</pre>
<p>In the next step we’ll try to write a function which returns a SETOF containing our data.</p>
<h2 id="fcf502e3df370b348fe8673d274ac2ff">0×3 SETOF vs. Array</h2>
<p>Now we need a function which returns our data as a SETOF. In my function I can declare ‘l_row’ of type ‘t_employee’ (see below). In this variable data is structured as in the table ‘t_employee’. So far, no big deal. Just let us have a look at the function:</p>
<pre class="brush: sql">CREATE or REPLACE FUNCTION get_employee()
   RETURNS SETOF t_employees AS
$BODY$

DECLARE
   l_row t_employee;

BEGIN

   -- Loop through rows
   FOR l_row IN
      SELECT * FROM t_employee
   LOOP
      -- Return data
      RETURN NEXT l_row;
   END LOOP;
END;
$BODY$
   LANGUAGE 'plpgsql';</pre>
<p>Okay. But as you might have noticed, the purpose of this howto ist to show you how to get a SETOF from an array. Therefor we need some array. We’ll modify ‘get_employees’ in this way:</p>
<pre class="brush: sql">CREATE or REPLACE FUNCTION get_employee()
   RETURNS SETOF t_employee AS
$BODY$

DECLARE
   l_row t_employee;
   l_array t_employee[];

BEGIN

   -- Loop throught rows
   FOR l_row IN
      SELECT * FROM t_employee
   LOOP
      -- Put all data into array
      SELECT array_append(l_array,l_row) INTO l_array;
   END LOOP;
   ...
END;
$BODY$
   LANGUAGE 'plpgsql';</pre>
<p>IN the next step we’ll have to extract SETOF data from the array. Since you can’t do that with built-in Postgres functions, we’ll need some auxiliary function:</p>
<pre class="brush: sql">/*
   Polymorphic function 'unnest': ANYARRAY -&gt; SETOF
   Return SETOF from ANYARRAY
*/

CREATE or REPLACE FUNCTION unnest(ANYARRAY)
RETURNS SETOF ANYELEMENT
LANGUAGE SQL AS

$$
   SELECT $1[i] FROM generate_series(array_lower($1,1),array_upper($1,1)) i;
$$;</pre>
<p>I hope you have noticed the ‘anyarray’ which is given as a parameter to the function. So you can use ‘unnest’ for every type of array. That’s the great point when using polymorphic functions: You have some kind of generic function and you can use it for all arrays. Well having this function implemented, we can now modify ‘get_employees’:</p>
<pre class="brush: sql">CREATE or REPLACE FUNCTION get_employee()
   RETURNS SETOF t_employee AS
$BODY$

DECLARE
   l_row t_employee;
   l_array t_employee[];

BEGIN

   -- Loop throught rows
   FOR l_row IN
      SELECT * FROM t_employee
   LOOP
      -- Put all data into array
      SELECT array_append(l_array,l_row) INTO l_array;
   END LOOP;

   -- ARRAY -&gt; SETOF
   FOR l_row IN
      SELECT * FROM unnest(l_array)
   LOOP
      return next l_row;
   END LOOP; 
END;
$BODY$
   LANGUAGE 'plpgsql';</pre>
                </div>
<hr/>
<div style="float:left;">
	Prev: <a href="http://blog.dornea.nu/2009/03/18/bye-bye-immobilo" align='left'>
	 Bye Bye Immobilo!
	</a>
</div>
<div style="float:right;">
    Next: <a href="http://blog.dornea.nu/2009/04/01/no-more-music-videos-on-youtube" align='right'>
	 No more music videos on Youtube!
	</a>
</div>
</p>

                <!-- Add comments -->
<div id="content-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname="dorneanu";
				var disqus_identifier = 'howto-get-setof-from-array-in-postgresql';
			var disqus_url = 'http://blog.dornea.nu/2009/03/30/howto-get-setof-from-array-in-postgresql';

		var disqus_config = function () {
			this.language = "en";
		};
 
        
        (function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})();</script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div> 
            </div>
            <div class="niu2-right-container col-md-2">
                <div id="niu2-sidebar-meta" class="niu2-sidebar">
                    <div class="niu2-sidebar-label"><i class="icon-calendar"></i>Published:</div>
                    <div class="niu2-sidebar-value">2009-03-30 00:00</div>
                    <div class="niu2-sidebar-label"><i class="icon-pencil"></i>category:</div>
                    <div class="niu2-sidebar-value"><a href="http://blog.dornea.nu/category/blog">blog</a></div>
                    <div class="niu2-sidebar-label"><i class="icon-tag"></i>Tag:</div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/coding/">coding</a><sup>23</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/howto/">howto</a><sup>20</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/sql/">sql</a><sup>1</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/admin/">admin</a><sup>21</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/postgresql/">postgresql</a><sup>1</sup></div>
                </div>

                <div id="niu2-sidebar-toc" class="niu2-sidebar" data-status="closed">
                    <div class="niu2-sidebar-label">
                        <i id="niu2-sidebar-toc-ctrl" class="icon-open-tocs"></i>Table of contents
                    </div>
                    <ul id="niu2-sidebar-toc-list">
                        <li><a href="#content-heading">HowTo: Get SETOF from Array in PostgreSQL</a></li>
                        <li><a href='#fcc5130196975f3e8ee1dde598a0600b'>0×1 Polymorphic types</a></li><li><a href='#d98ccf21b89cc65b3ea9286fd7ec1509'>0×2 Getting started</a></li><li><a href='#fcf502e3df370b348fe8673d274ac2ff'>0×3 SETOF vs. Array</a></li>
                        <li><a href="#content-comments">Comments</a></li>
                    </ul>
                </div>
            </div>
            <div id="niu2-toolbar">
                <ul class="list-unstyled">
                    <li><a id="niu2-toolbar-ctrlsidebar" href="#" title="Hide Sidebar"><i class="icon-3x icon-hide-sidebar"></i></a></li>
                </ul>
                <div id="niu2-toolbar-showsidebar" data-title="Show Sidebar"></div>
                <div id="niu2-toolbar-github" data-repo=""></div>
                <div id="niu2-toolbar-bitbucket" data-repo=""></div>
            </div>
            <div id="niu2-toc" data-style="fixed"></div>
        </div>

        <div class="niu2-footer">
            <div id="body-footer" class="col-md-6 col-md-offset-2">
                <hr/>
                <p>
                    Powered by <a href="https://github.com/getpelican/pelican">Pelican</a>, 
                    <a href="https://github.com/mawenbao/niu-x2-sidebar">theme</a> built with <a href="https://github.com/twbs/bootstrap">Bootstrap3</a>
                    by <a href="https://blog.mawenbao.com">Ma Wenbao</a>, icons by 
                    <a href="https://fortawesome.github.io/Font-Awesome">Font Awesome</a>.
                </p>
                <p>
                    © 2008 - 2016
                    <a class="niu2-footer-link" href="http://blog.dornea.nu">Victor Dorneanu</a>
                </p>
                <p class="niu2-icons">
                    <a class="niu2-footer-icon" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x18F1AD46FB05E1B7" title="my public key">
                        <i class="icon-key icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="mailto: no-spam ÄATT dornea DOT nu" title="my email address">
                        <i class="icon-envelope-o icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="http://github.com/dorneanu" title="my github page">
                        <i class="icon-github-alt icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="/feeds/rss.xml" title="subscribe my blog">
                        <i class="icon-rss icon-lg"></i>
                    </a>
                </p>
            </div>
        </div>

        <script type="text/javascript">
            var _gaq=_gaq||[];
            _gaq.push(["_setAccount","UA-7161767-3"]);
            _gaq.push(["_trackPageview"]);
            (function(){
                var b=document.createElement("script");
                b.type="text/javascript";
                b.async=true;
                b.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";
                var a=document.getElementsByTagName("script")[0];
                a.parentNode.insertBefore(b,a)
            })();
        </script>
        <div id="niu2-pygments" data-theme="github"></div>
        <div id="niu2-lazy-load" data-loading-txt="Loading image" data-loading-icon="icon-spin icon-spinner"></div>
        <div id="niu2-toolbar-load" data-loading-icon="icon-spin icon-4x icon-spinner"></div>
        <script type="text/javascript" src="http://blog.dornea.nu/theme/js/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="http://blog.dornea.nu/theme/js/niu2.min.js"></script>
        <script type="text/javascript" src="http://blog.dornea.nu/theme/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/js/custom.js"></script>
        <script type="text/javascript">
            onContentLoaded();
        </script>
    </body>
</html>