<!DOCTYPE html>
<html lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="keywords" content="ipython, hacking, security, android, python, mobile, appsec, eclipse, c, gdb">
        <meta name="description" content="Since I haven't done this before, I thought I could share some experiences with you. All this began during some APK analysis which was heavily using JNIs. In my particular case Java Native Interfaces were used to call functions inside libraries written in C/C++. At that time ...">
        <title>Debugging Android native shared libraries - blog.dornea.nu</title>
        <link rel="shortcut icon" type="image/x-icon" href="/favicon.png">
        <link rel="stylesheet" href="/css/ipython.min.css" type="text/css" />
        <link rel="stylesheet" href="http://blog.dornea.nu/theme/css/bootstrap.min.css" type="text/css" />
        <link rel="stylesheet" href="http://blog.dornea.nu/theme/font-icons/style.min.css" type="text/css" />
        <link rel="stylesheet" href="http://blog.dornea.nu/theme/css/niu2.min.css" type="text/css" />
        <link rel="stylesheet" href="/css/custom.css" type="text/css" />
		
        <script type="text/javascript" src="http://blog.dornea.nu/theme/js/jquery-1.11.0.min.js"></script>
        <script type="text/javascript" src="http://blog.dornea.nu/theme/js/niu2.min.js"></script>
        <script type="text/javascript" src="http://blog.dornea.nu/theme/js/bootstrap.min.js"></script>
        
        <link rel="canonical" href="http://blog.dornea.nu/2015/07/01/debugging-android-native-shared-libraries" />
        <script type="text/javascript">window.onload=function(){};</script>
        <!--[if lt IE 9]>
            <script src="http://blog.dornea.nu/theme/js/html5shiv.js"></script>
            <script src="http://blog.dornea.nu/theme/js/respond.min.js"></script>
        <![endif]-->
    </head>
    <body> 
        <div id="body-header">
            <div class="navbar navbar-inverse navbar-fixed-top">
                <div class="col-md-12">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="http://blog.dornea.nu">
                            <i class="icon-home"></i>blog.dornea.nu
                        </a>
                    </div>
                    <nav class="collapse navbar-collapse bs-navbar-collapse" role="navigation">
                        <ul class="nav navbar-nav">
                            <li><a href="http://dornea.nu" title="about">
                                <i class="icon-user"></i>about</a>
                            </li>
                            <li><a href="/archives.html" title="archives">
                                <i class="icon-archive"></i>archives</a>
                            </li>
                            <li><a href="/tags.html" title="tags">
                                <i class="icon-tag"></i>tags</a>
                            </li>
                            <li><a href="/feeds/rss.xml" title="feeds">
                                <i class="icon-rss"></i>feeds</a>
                            </li>
                        <!-- category dropdown list -->
                        <li class="dropdown">
                           <a href="#" class="dropdown-toggle" data-toggle="dropdown">
                                <i class="icon-folder-open"></i>category<b class="caret"></b>
                           </a>
                           <ul class="dropdown-menu">
                               <li><a href="http://blog.dornea.nu/category/blog">
                                      <i class="icon-pencil"></i>blog
                                      (113)</a></li>
                               <li><a href="http://blog.dornea.nu/category/low">
                                   <i class="icon-folder-close"></i>LOW
                                      (27)</a></li>
                               <li><a href="http://blog.dornea.nu/category/notes">
                                      <i class="icon-book"></i>notes
                                      (21)</a></li>
                           </ul>
                        </li>
                        <!--  self defined dropdown list -->
                        </ul>
                        
                        <!-- right nav bar -->
                        <ul class="nav navbar-nav navbar-right">
                        <!-- google custom search -->
                        <li>
                        <div id="niu2-cse-wrapper">
                            <div id="niu2-cse-header-box" class="navbar-form navbar-nav">
                                <form action="http://google.com/cse">
                                    <input type="hidden" name="cx" value="008508447409818574933:pxyxuhrgnxi" />
                                    <input type="hidden" name="ie" value="UTF-8" />
                                    <div class="form-group">
                                        <input id="niu2-cse-search-input" class="niu2-cse-header form-control" 
                                            type="text" name="q" 
                                            placeholder="Press enter to search ..."/>
                                    </div>
                                </form>
                           </div>
                           <div id="niu2-cse-ctrl-box" class="navbar-nav">
                            <i id="niu2-cse-search-image" class="icon-search navbar-nav"></i><span id="niu2-cse-search-text">Search</span>
                           </div>
                       </div>
                       </li>
                       </ul>
                    </nav>
                </div>
            </div>
<style>
    #banner{
        background-image:url("http://blog.dornea.nu//images/header.jpg");
    }   
</style>

<div id="banner">
    <div class="container">
        <div class="copy">
            <h2>blog.dornea.nu</h2>
                <p class="intro">Hack, code and drink some țuică. Personal blog of Victor Dorneanu.</p>
        </div>
    </div>
</div>
            <!-- End Banner -->
        </div>

        <div id="body-content">
            <div class="col-md-8 col-md-offset-2">
                <h1 id="content-heading">Debugging Android native shared libraries</h1>
            </div>
            <div id="niu2-left-container" class="col-md-6 col-md-offset-2 with-right-border">
                <div id="niu2-main-content">
                    <p>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Since I haven't done this before, I thought I could share some experiences with you. All this began during some APK analysis which was heavily using <a href="https://en.wikipedia.org/wiki/Java_Native_Interface">JNI</a>s. In my particular case <em>Java Native Interfaces</em> were used to call functions inside libraries written in C/C++. At that time I was quite unfamiliar with JNIs and how they actually work. Besides that I haven't debugged any native applications/libraries on Android before. So this was the perfect opportunity to have a closer look at <a href="https://developer.android.com/tools/sdk/ndk/index.html">Android NDK</a> and its debugging features.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="5a73c3a04b1cadec1079dd6a320ce367">Create Eclipse project<a class="anchor-link" href="#Create-Eclipse-project">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In this post I'll first create and build a <em>simple</em> Android project that includes native code using the <strong>JNI</strong>. As a main source I have used this extraordinary <a href="http://blog.edwards-research.com/2012/04/tutorial-android-jni/">Android JNI tutorial</a> which I highly appreciate. Following the instructions described in the post, I have managed to successfully create an empty Android project (File -&gt; New -&gt; Project -&gt; Android Application Project) for my purposes.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [28]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">tree</span> <span class="o">-</span><span class="n">L</span> <span class="mi">1</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">.
├── AndroidManifest.xml
├── assets
├── build.xml
├── ic_launcher-web.png
├── jni
├── res
└── src

4 directories, 3 files
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And in <code>src</code> we have following <strong>classes</strong>:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [29]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">ls</span> <span class="o">-</span><span class="n">lR</span> <span class="n">src</span><span class="o">/</span><span class="n">com</span><span class="o">/</span><span class="n">example</span><span class="o">/</span><span class="n">jni_debug_demo</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">src/com/example/jni_debug_demo:
total 8
-rw-r--r-- 1 victor users 1183 Jun 30 16:44 MainActivity.java
-rw-r--r-- 1 victor users  471 Jun 30 16:44 SquaredWrapper.java
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="3db753280a88ebe0a48885a81095a17d">Create Android project<a class="anchor-link" href="#Create-Android-project">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to be able to build the APK, you'll have to create a new Android project:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [30]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">victor</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">sdk</span><span class="o">/</span><span class="n">tools</span><span class="o">/</span><span class="n">android</span> <span class="n">update</span> <span class="n">project</span> <span class="o">--</span><span class="n">target</span> <span class="n">android</span><span class="o">-</span><span class="mi">19</span> <span class="o">-</span><span class="n">p</span> <span class="o">.</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">Updated and renamed default.properties to project.properties
Updated local.properties
Added file ./proguard-project.txt
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now you should be able to <strong>build</strong> the project and also generate the <strong>APK</strong>:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [31]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">ant</span> <span class="n">clean</span> <span class="n">release</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">BUILD</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">BUILD SUCCESSFUL
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="8742c5f749ad86585a6730c9a295d83f">Add JNI functionalities<a class="anchor-link" href="#Add-JNI-functionalities">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have the base Android project, let's add some <strong>JNI</strong> functionalities to the project. To compile the shared library (using gcc/g++) we'll need a valid C <strong>header</strong> which can be computed from <em>SquaredWrapper</em> (class used in previously mentioned tutorial).</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="60f24e461e47e35a67c1646440b1517d">C header<a class="anchor-link" href="#C-header">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The compiled classes are now in "<code>./bin/classes</code>". Let's generate the <strong>header</strong> files for <code>SquaredWrapper</code>:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [37]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">javah</span> <span class="o">-</span><span class="n">jni</span> <span class="o">-</span><span class="n">classpath</span> <span class="o">~/</span><span class="n">work</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">sdk</span><span class="o">/</span><span class="n">platforms</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="mi">19</span><span class="o">/</span><span class="n">android</span><span class="o">.</span><span class="n">jar</span><span class="p">:</span><span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">classes</span> <span class="o">-</span><span class="n">o</span> <span class="n">square</span><span class="o">.</span><span class="n">h</span> <span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">jni_debug_demo</span><span class="o">.</span><span class="n">SquaredWrapper</span>
<span class="n">cat</span> <span class="n">square</span><span class="o">.</span><span class="n">h</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">/* DO NOT EDIT THIS FILE - it is machine generated */
#include &lt;jni.h&gt;
/* Header for class com_example_jni_debug_demo_SquaredWrapper */

#ifndef _Included_com_example_jni_debug_demo_SquaredWrapper
#define _Included_com_example_jni_debug_demo_SquaredWrapper
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_example_jni_debug_demo_SquaredWrapper
 * Method:    squared
 * Signature: (I)I
 */
JNIEXPORT jint JNICALL Java_com_example_jni_1debug_1demo_SquaredWrapper_squared
  (JNIEnv *, jclass, jint);

#ifdef __cplusplus
}
#endif
#endif
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So there is a function <strong>Java_com_example_jni_1debug_1demo_SquaredWrapper_squared</strong> (pay attention to the naming convention) which has 3 arguments. I won't discuss this further and I'll simple copy the file into a new folder <code>jni</code> inside the project:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [38]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">mkdir</span> <span class="n">jni</span>
<span class="n">mv</span> <span class="n">square</span><span class="o">.</span><span class="n">h</span> <span class="n">jni</span><span class="o">/</span>
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="befb599f3c079222c08ed59961472c1c">C source<a class="anchor-link" href="#C-source">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that we have the <strong>function definition</strong> and the prototype generated by <code>javah</code> we can easily implement the <strong>C source</strong> as follows:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [39]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">cat</span> <span class="n">jni</span><span class="o">/</span><span class="n">square</span><span class="o">.</span><span class="n">c</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">#include "square.h"
 
JNIEXPORT jint JNICALL Java_com_example_jni_1debug_1demo_SquaredWrapper_squared (JNIEnv * je, jclass jc, jint base)
{
    return (base*base);
}
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>So nothing special about it. Due to the introductory aspect of this post I'll try to keep things simple. You can of course go further and implement more complex functions. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="3167ee0d828bb1864e420e8e255aea2e">Build the library<a class="anchor-link" href="#Build-the-library">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Create a <strong>Makefile</strong> for all the Android build tools. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [40]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%</span><span class="k">cat</span> <span class="n">jni</span><span class="o">/</span><span class="n">Android</span><span class="o">.</span><span class="n">mk</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">LOCAL_PATH := $(call my-dir)
 
include $(CLEAR_VARS)

LOCAL_LDLIBS := -llog

LOCAL_MODULE    := squared
LOCAL_SRC_FILES := square.c
 
include $(BUILD_SHARED_LIBRARY)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>And now <strong>build</strong> the library (remember to set the <em>NDK_DEBUG</em> flag otherwise you won't be able to debug your native code):</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [41]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">NDK_DEBUG</span><span class="o">=</span><span class="mi">1</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">victor</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">ndk</span><span class="o">-</span><span class="n">r10e</span><span class="o">/</span><span class="n">ndk</span><span class="o">-</span><span class="n">build</span> 
<span class="n">readelf</span> <span class="o">-</span><span class="n">h</span> <span class="n">libs</span><span class="o">/</span><span class="n">armeabi</span><span class="o">/</span><span class="n">libsquared</span><span class="o">.</span><span class="n">so</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">Android NDK: WARNING: APP_PLATFORM android-19 is larger than android:minSdkVersion 16 in ./AndroidManifest.xml    
[armeabi] Gdbserver      : [arm-linux-androideabi-4.8] libs/armeabi/gdbserver
[armeabi] Gdbsetup       : libs/armeabi/gdb.setup
[armeabi] Compile thumb  : squared &lt;= square.c
[armeabi] SharedLibrary  : libsquared.so
[armeabi] Install        : libsquared.so =&gt; libs/armeabi/libsquared.so
ELF Header:
  Magic:   7f 45 4c 46 01 01 01 00 00 00 00 00 00 00 00 00 
  Class:                             ELF32
  Data:                              2&amp;apos;s complement, little endian
  Version:                           1 (current)
  OS/ABI:                            UNIX - System V
  ABI Version:                       0
  Type:                              DYN (Shared object file)
  Machine:                           ARM
  Version:                           0x1
  Entry point address:               0x0
  Start of program headers:          52 (bytes into file)
  Start of section headers:          12564 (bytes into file)
  Flags:                             0x5000000, Version5 EABI
  Size of this header:               52 (bytes)
  Size of program headers:           32 (bytes)
  Number of program headers:         8
  Size of section headers:           40 (bytes)
  Number of section headers:         21
  Section header string table index: 20
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="76919fe41c886cd94adabaf467a6c722">Call the library<a class="anchor-link" href="#Call-the-library">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In <code>MainActivity</code> some static routines of the class <code>SquaredWrapper</code> are being called:</p>
<pre><code class="language-.java"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="id">MainActivity</span> <span class="id">extends</span> <span class="id">Activity</span> {</span>
    <span class="keyword">private</span> EditText etInput;
    <span class="keyword">private</span> TextView txtTo2;
    <span class="keyword">private</span> TextView txtTo4;

    @Override
    <span class="keyword">protected</span> <span class="keyword">void</span> onCreate(Bundle savedInstanceState) {
        <span class="keyword">super</span><span class="variable">.onCreate</span>(savedInstanceState);
        setContentView(R<span class="variable">.layout</span><span class="variable">.activity_main</span>);

        <span class="comment">// Define Input EditText, TextViews</span>
        etInput = (EditText) findViewById(R<span class="variable">.id</span><span class="variable">.etInput</span>);
        txtTo2 =  (TextView) findViewById(R<span class="variable">.id</span><span class="variable">.resTo2</span>);
        txtTo4 =  (TextView) findViewById(R<span class="variable">.id</span><span class="variable">.resTo4</span>);

        <span class="keyword">int</span> b = <span class="number">3</span>;
        <span class="keyword">int</span> a = SquaredWrapper<span class="variable">.to4</span>(b);
        Log<span class="variable">.i</span>(<span class="string">"JNIDemo"</span>, String<span class="variable">.format</span>(<span class="string">"%d-&gt;%d"</span>, b,a));
    }

    <span class="keyword">public</span> <span class="keyword">void</span> cbCalculate(View view) {
        <span class="keyword">int</span> in = <span class="number">0</span>;
        <span class="keyword">try</span>{
            in = Integer<span class="variable">.valueOf</span>( etInput<span class="variable">.getText</span>()<span class="variable">.toString</span>() );
        } <span class="keyword">catch</span>(NumberFormatException e) { 
            <span class="keyword">return</span> ; 
        }

        txtTo2<span class="variable">.setText</span>(String<span class="variable">.format</span>(<span class="string">"%d"</span>, SquaredWrapper<span class="variable">.squared</span>(in)));
        txtTo4<span class="variable">.setText</span>(String<span class="variable">.format</span>(<span class="string">"%d"</span>, SquaredWrapper<span class="variable">.to4</span>(in)));
    }
}
</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Build the project again:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [42]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">ant</span> <span class="n">clean</span> <span class="n">release</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="s">"^BUILD"</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">BUILD SUCCESSFUL
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="4c061f922fcf6cd1d715b6f8672e4408">Run the demo application<a class="anchor-link" href="#Run-the-demo-application">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First let's build the APK with <strong>debug</strong> enabled and sign it using a debug key:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [43]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">ant</span> <span class="n">clean</span> <span class="n">debug</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="s">"^BUILD"</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">BUILD SUCCESSFUL
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now you can <strong>install</strong> <code>./bin/MainActivity-debug.apk</code> on your Android device (whether virtual or real)</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [44]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">victor</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">sdk</span><span class="o">/</span><span class="n">platform</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">adb</span> <span class="n">devices</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">List of devices attached 
0123456789ABCDEF	device

</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [47]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">install</span> <span class="o">./</span><span class="nb">bin</span><span class="o">/</span><span class="n">MainActivity</span><span class="o">-</span><span class="n">debug</span><span class="o">.</span><span class="n">apk</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">WARNING: linker: libvc1dec_sa.ca7.so has text relocations. This is wasting memory and is a security risk. Please fix.
WARNING: linker: libvc1dec_sa.ca7.so has text relocations. This is wasting memory and is a security risk. Please fix.
	pkg: /data/local/tmp/MainActivity-debug.apk
Success
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [91]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="n">am</span> <span class="n">start</span> <span class="o">-</span><span class="n">n</span> <span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">jni_debug_demo</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">jni_debug_demo</span><span class="o">.</span><span class="n">MainActivity</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">WARNING: linker: libvc1dec_sa.ca7.so has text relocations. This is wasting memory and is a security risk. Please fix.
WARNING: linker: libvc1dec_sa.ca7.so has text relocations. This is wasting memory and is a security risk. Please fix.
Starting: Intent { cmp=com.example.jni_debug_demo/.MainActivity }
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><img alt="JNI Debug Demo Application" class="img-responsive" src="http://dl.dornea.nu/img/2015/android-solib/a74f0e9adca736086c2834fb63c793ad.png"/></p>
<p>Greping for the <strong>logcat messages</strong> shows:</p>
<pre><code class="language-.shell"><span class="comment">$</span> <span class="comment">adb</span> <span class="comment">logcat</span> <span class="literal">-</span><span class="comment">s</span> <span class="comment">JNIDemo</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">beginning</span> <span class="comment">of</span> <span class="comment">/dev/log/system</span>
<span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span><span class="literal">-</span> <span class="comment">beginning</span> <span class="comment">of</span> <span class="comment">/dev/log/main</span>
<span class="comment">I/JNIDemo</span> <span class="comment">(</span> <span class="comment">5524):</span> <span class="comment">3</span>-&gt;<span class="comment">81</span>
<span class="comment">I/JNIDemo</span> <span class="comment">(</span> <span class="comment">5524):</span> <span class="comment">3</span>-&gt;<span class="comment">81</span>
<span class="comment">I/JNIDemo</span> <span class="comment">(</span> <span class="comment">5524):</span> <span class="comment">3</span>-&gt;<span class="comment">81</span>
<span class="comment">^C
</span></code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="8a41ffef1d93ae9488256f7a78aa47be">Debug the application<a class="anchor-link" href="#Debug-the-application">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the next steps a <strong>rooted</strong> device is <em>required</em>. Besides that you should install the <em>Android NDK</em> if you haven't done this yet. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="c42d5ee5a38a904c5b25b4cf5b5eb955">Remount /system as rw<a class="anchor-link" href="#Remount-/system-as-rw">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>First you'll have to <em>mount</em> <code>/system</code> with read-write rights:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [103]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="n">mount</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="s">"system"</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">/emmc@android /system ext4 ro,seclabel,noatime,noauto_da_alloc,commit=1,data=ordered 0 0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [49]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="s">"su -c 'mount -o rw,remount /system'"</span>
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [50]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="n">mount</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="s">"system"</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">/emmc@android /system ext4 rw,seclabel,relatime,noauto_da_alloc,commit=1,data=ordered 0 0
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="eefbac16c9d82bad4406d3d902964a0d">Copy gdbserver to device<a class="anchor-link" href="#Copy-gdbserver-to-device">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now you'll have to copy the <strong>gdbserver</strong> from the Android NDK into <code>/system/bin</code>:</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [100]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">find</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">victor</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">ndk</span><span class="o">-</span><span class="n">r10e</span><span class="o">/</span> <span class="o">-</span><span class="nb">type</span> <span class="n">f</span> <span class="o">-</span><span class="n">name</span> <span class="s">"gdbserver"</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">/home/victor/work/android-ndk-r10e/prebuilt/android-mips/gdbserver/gdbserver
/home/victor/work/android-ndk-r10e/prebuilt/android-x86_64/gdbserver/gdbserver
/home/victor/work/android-ndk-r10e/prebuilt/android-arm64/gdbserver/gdbserver
/home/victor/work/android-ndk-r10e/prebuilt/android-x86/gdbserver/gdbserver
/home/victor/work/android-ndk-r10e/prebuilt/android-mips64/gdbserver/gdbserver
/home/victor/work/android-ndk-r10e/prebuilt/android-arm/gdbserver/gdbserver
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [107]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="n">cat</span> <span class="o">/</span><span class="n">proc</span><span class="o">/</span><span class="n">cpuinfo</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">e</span> <span class="s">"Processor"</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">Processor	: ARMv7 Processor rev 3 (v7l)
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [52]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">push</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">victor</span><span class="o">/</span><span class="n">work</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">ndk</span><span class="o">-</span><span class="n">r10e</span><span class="o">/</span><span class="n">prebuilt</span><span class="o">/</span><span class="n">android</span><span class="o">-</span><span class="n">arm</span><span class="o">/</span><span class="n">gdbserver</span><span class="o">/</span><span class="n">gdbserver</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">sdcard</span><span class="o">/</span><span class="n">tmp</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="s">"su -c 'cp /mnt/sdcard/tmp/gdbserver /system/bin/'"</span>
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="bd344e0d8803fe6797cd0e80cc5639ad">Copy ARM libraries to your client<a class="anchor-link" href="#Copy-ARM-libraries-to-your-client">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In order to be able to find debug information/symbols you'll need  all ARM libraries all your device/emulator to be copied to your PC. <code>gdb</code> will need them later on.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [12]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">mkdir</span> <span class="n">system_lib</span>
<span class="n">cd</span> <span class="n">system_lib</span>
<span class="n">adb</span> <span class="n">pull</span> <span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">lib</span> <span class="mi">2</span><span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="c05250ac6ed45919e7c8c882e3669410">Run the application<a class="anchor-link" href="#Run-the-application">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [4]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="n">am</span> <span class="n">start</span> <span class="o">-</span><span class="n">n</span> <span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">jni_debug_demo</span><span class="o">/</span><span class="n">com</span><span class="o">.</span><span class="n">example</span><span class="o">.</span><span class="n">jni_debug_demo</span><span class="o">.</span><span class="n">MainActivity</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">WARNING: linker: libvc1dec_sa.ca7.so has text relocations. This is wasting memory and is a security risk. Please fix.
WARNING: linker: libvc1dec_sa.ca7.so has text relocations. This is wasting memory and is a security risk. Please fix.
Starting: Intent { cmp=com.example.jni_debug_demo/.MainActivity }
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [5]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">adb</span> <span class="n">shell</span> <span class="n">ps</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">jni_debug_demo</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stdout">
<pre class="ipynb">u0_a159   28054 135   554400 14484 ffffffff 00000000 S com.example.jni_debug_demo
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Now that the app is running we're ready to start the debugger and attach it to the process ID <em>28054</em>. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="97ff27fb42962b1b0f4eef4e46138ab4">Attach gdb to process<a class="anchor-link" href="#Attach-gdb-to-process">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>In project's root directory you'll run <code>ndk-gdb</code> which is part of the <em>Android NDK</em> package. </p>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">
<div class="prompt input_prompt">
In [10]:
</div>
<div class="input_area box-flex1">
<div class="highlight-ipynb"><pre class="ipynb"><span class="o">%%</span><span class="k">bash</span>
<span class="n">ndk</span><span class="o">-</span><span class="n">gdb</span> <span class="o">--</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span>
</pre></div>
</div>
</div>
<div class="output_wrapper">
<div class="output">
<div class="output_area"><div class="prompt"></div>
<div class="box-flex1 output_subarea output_stream output_stderr">
<pre class="ipynb">warning: Could not load shared library symbols for 108 libraries, e.g. libstdc++.so.
Use the "info sharedlibrary" command to see the complete listing.
Do you need "set solib-search-path" or "set sysroot"?
</pre>
</div>
</div>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Without paying attention to the <em>warning</em> message, here are the steps <code>ndk-gdb</code> will do for you</p>
<ul>
<li>check if application is running</li>
<li>setup network redirection (port forwarding)</li>
</ul>
<pre><code>adb_cmd forward tcp:5039 localfilesystem:/data/data/com.example.jni_debug_demo/debug-socket
</code></pre><ul>
<li>pull several utilities (app_process, linker) from the device/emulator</li>
<li>start <code>gdb</code></li>
<li>attach to the process</li>
</ul>
<p>One could of course do all these steps <strong>manually</strong>. </p>
<p>1) Do port <em>forwarding</em>:</p>
<pre><code>$ adb forward tcp:1337 tcp:1337
</code></pre><p>1) Attach <code>gdbserver</code> to the process (on the device)</p>
<pre><code>root@Android:/ # ps | grep jni
u0_a159   28054 135   561056 14100 ffffffff 400a499c S com.example.jni_debug_demo
root@Android:/ # gdbserver :1337 --attach 28054                                
Attached; pid = 28054
Listening on port 1337
</code></pre><p>2) Connect gdb <code>client</code> to the server:</p>
<pre><code>$ /home/victor/work/android-ndk-r10e/toolchains/arm-linux-androideabi-4.9/prebuilt/linux-x86_64/bin/arm-linux-androideabi-gdb
...
&gt; target remote :1337
...
</code></pre><p>But I still recommend using <code>ndk-gdb</code>. </p>
<h3 id="eaae69963118347f34db7ec3d2c2d0d9">Read debugging information</h3>
<p>And now let's go back to the previously mentioned <code>warning</code> message:</p>
<pre><code>warning: Could not load shared library symbols for 108 libraries, e.g. libstdc++.so.
</code></pre><p><code>gdb</code> is telling us that it can't find any <strong>debugging symbols</strong> for the loaded (ARM) libraries. In that case we'll have to specify the <strong>path</strong> where it can find that information:</p>
<ul>
<li><code>system_lib</code>: contains all ARM libraries from the device (/system/lib)</li>
<li><code>obj/local/armeabi</code>: contains debugging information about <code>libsquared.so</code> (our target)</li>
</ul>
<pre><code>$ ndk-gdb --verbose
...
gef&gt; set solib-search-path system_lib/:obj/local/armeabi/
Reading symbols from system_lib/libc.so...(no debugging symbols found)...done.
Loaded symbols for system_lib/libc.so
Reading symbols from system_lib/libstdc++.so...(no debugging symbols found)...done.
Loaded symbols for system_lib/libstdc++.so
Reading symbols from system_lib/libm.so...(no debugging symbols found)...done.
Loaded symbols for system_lib/libm.so
Reading symbols from system_lib/liblog.so...(no debugging symbols found)...done.
Loaded symbols for system_lib/liblog.so
Reading symbols from system_lib/libcutils.so...(no debugging symbols found)...done.
...
</code></pre><p>You can now <strong>verify</strong> the debugging information via <code>info sharedlibrary</code>:</p>
<pre><code>gef&gt; info sharedlibrary
From        To          Syms Read   Shared Object Library
0x40053a80  0x400619e8  Yes (*)     /home/victor/workspace/jni_debug_demo/obj/local/armeabi/linker
0x4008c500  0x400d2e54  Yes (*)     /home/victor/workspace/jni_debug_demo/system_lib/libc.so
0x400f4828  0x400f49ec  Yes (*)     /home/victor/workspace/jni_debug_demo/system_lib/libstdc++.so
0x400f9940  0x4010d5b8  Yes (*)     /home/victor/workspace/jni_debug_demo/system_lib/libm.so
0x4007a190  0x4007bdf8  Yes (*)     /home/victor/workspace/jni_debug_demo/system_lib/liblog.so
0x4006f6c8  0x40074ac4  Yes (*)     /home/victor/workspace/jni_debug_demo/system_lib/libcutils.so
0x4012eb1c  0x40131210  Yes (*)     /home/victor/workspace/jni_debug_demo/system_lib/libgccdemangle.so
0x40142bf0  0x40152a84  Yes (*)     /home/victor/workspace/jni_debug_demo/system_lib/libz.so
...
0x60b5bbe4  0x60b5d174  Yes         /home/victor/workspace/jni_debug_demo/obj/local/armeabi/libsquared.so
                        No          gralloc.mt6582.so
(*): Shared library is missing debugging information.
</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="cd6f71941cbbe02f9a60b4ff7a043aa4">Find target function<a class="anchor-link" href="#Find-target-function">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>From last output you can see that <code>libsquared.so</code> starts at address <strong>0x60b5bbe4</strong>. Let's see what we can find there:</p>
<p><img alt="jni_debug_demo libsquared" class="img-responsive" src="http://dl.dornea.nu/img/2015/android-solib/b85df1e566b46ed748e315c3d4f043ed.png"/></p>
<p>Bingo! So <code>Java_com_example_jni_1debug_1demo_SquaredWrapper_squared</code> starts at <strong>0x60b5bc28</strong>. We'll definitely set a <strong>breakpoint</strong> at that address:</p>
<pre><code class="language-.shell">gef&gt; b Java_com_example_jni_1debug_1demo_SquaredWrapper_squared
Breakpoint <span class="number">1</span> <span class="keyword">at</span> <span class="number">0x60b5bc40</span>: <span class="type">file</span> jni/square.c, line <span class="number">5.</span>
gef&gt;
</code></pre>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="71b688fd082c180add0772dae6917606">Trigger and debug function<a class="anchor-link" href="#Trigger-and-debug-function">¶</a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>For the targeted function to be executed we'll have to trigger its execution by clicking on the "Calculate" button in the UI. <strong>Before</strong> doing that you should tell <code>gdb</code> to <em>continue</em> execution:</p>
<pre><code>gef&gt; continue
Continuing.
</code></pre><p>After having pressed the button in the UI, you should see sth similar to this:</p>
<pre><code>gef&gt; continue
Continuing.
--------------------------------------------------------------------------------[regs]
$r0    0x4187fe30 $r1    0x7a100019 $r2    0x00000008 $r3    0x578bbd18 
$r4    0x57c49258 $r5    0x41882860 $r6    0x00000004 $r7    0x578bbccc 
$r8    0xbed1e2a8 $r9    0x578bbcc4 $r10   0x41882870 $r11   0xbed1e2a4 
$r12   0x60b5bc28 $sp    0xbed1e290 $lr    0x418a1750 $pc    0x60b5bc40 

--------------------------------------------------------------------------------[stack]
0xbed1e290: 
0xbed1e294: 
0xbed1e298: 
0xbed1e29c: 
0xbed1e2a0: 
0xbed1e2a4: 
0xbed1e2a8: 
0xbed1e2ac: 
0xbed1e2b0: 
0xbed1e2b4: 
--------------------------------------------------------------------------------[code]
0x60b5bc2c       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+4&gt;:  add     r11, sp, #0
0x60b5bc30       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+8&gt;:  sub     sp, sp, #20
0x60b5bc34       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+12&gt;: str     r0, [r11, #-8]
0x60b5bc38       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+16&gt;: str     r1, [r11, #-12]
0x60b5bc3c       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+20&gt;: str     r2, [r11, #-16]
0x60b5bc40       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+24&gt;: ldr     r3, [r11, #-16] &lt;&lt;= 
0x60b5bc44       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+28&gt;: ldr     r2, [r11, #-16]
0x60b5bc48       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+32&gt;: mul     r3, r2, r3
0x60b5bc4c       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+36&gt;: mov     r0, r3
0x60b5bc50       &lt;Java_com_example_jni_1debug_1demo_SquaredWrapper_squared+40&gt;: sub     sp, r11, #0
--------------------------------------------------------------------------------[trace]
#0  Java_com_example_jni_1debug_1demo_SquaredWrapper_squared (je=0x4187fe30, jc=0x7a100019, base=8) at jni/square.c:5
#1  0x418a1750 in ?? ()
Backtrace stopped: previous frame identical to this frame (corrupt stack?)

Breakpoint 1, Java_com_example_jni_1debug_1demo_SquaredWrapper_squared (je=0x4187fe30, jc=0x7a100019, base=8) at jni/square.c:5
5           return (base*base);
</code></pre><p>You can see that the execution currently stopped at <strong>0x60b5bc40</strong>. Now you can inspect the <em>registers</em>, set <em>additional</em> breakpoints, <em>step</em> into routines etc. </p>
<p><img alt="GDB GEF" class="img-responsive" src="http://dl.dornea.nu/img/2015/android-solib/1c34d2da522b2a450b603cf8cd6a965a.png">
<img alt="GDB GEF" class="img-responsive" src="http://dl.dornea.nu/img/2015/android-solib/18d6146e96dbb21ceed498ae1cdd92f4.png"/></img></p>
<p>At this point you should now be equipped with enough knowledge to dissect shared libraries and get some reverse engineering job done. Although this was a quite easy one due to the fact that we had debug symbols and were able to compile the library, the same techniques should also work on <em>stripped</em> binaries. In the post I'll some <em>binary analysis</em> on some random Android shared library using <a href="http://www.radare.org/r/">radare</a>.</p>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="5cd6478416b226b632eb44888361e8d8">References<a class="anchor-link" href="#References">¶</a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered">
<div class="prompt input_prompt">
</div>
<div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li><a href="https://github.com/dorneanu/test/tree/master/jni_debug_demo">jni_debug_demo GitHub Project</a></li>
<li><a href="http://blog.edwards-research.com/2012/04/tutorial-android-jni/">Tutorial: Android JNI</a></li>
<li><a href="http://code.tutsplus.com/tutorials/advanced-android-getting-started-with-the-ndk--mobile-2152">Advanced Android: Getting started with the NDK</a></li>
<li><a href="https://tthtlc.wordpress.com/2012/09/19/how-to-do-remote-debugging-via-gdbserver-running-inside-the-android-phone/">How to do remote debugging via gdbserver running inside the Android phone?</a></li>
</ul>
</div>
</div>
</div></p>
                </div>
<hr/>
<div style="float:left;">
	Prev: <a href="http://blog.dornea.nu/2015/06/03/usd-ag-hacker-day-in-hamburg" align='left'>
	 usd AG Hacker Day in Hamburg
	</a>
</div>
<div style="float:right;">
    Next: <a href="http://blog.dornea.nu/2015/09/17/organizing-and-visualizing-knowledge" align='right'>
	 Organizing and visualizing knowledge
	</a>
</div>
</p>

                <!-- Add comments -->
<div id="content-comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname="dorneanu";
				var disqus_identifier = 'debugging-android-native-shared-libraries';
			var disqus_url = 'http://blog.dornea.nu/2015/07/01/debugging-android-native-shared-libraries';

		var disqus_config = function () {
			this.language = "en";
		};
 
        
        (function(){var a=document.createElement("script");a.type="text/javascript";a.async=true;a.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(a)})();</script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div> 
            </div>
            <div class="niu2-right-container col-md-2">
                <div id="niu2-sidebar-meta" class="niu2-sidebar">
                    <div class="niu2-sidebar-label"><i class="icon-calendar"></i>Published:</div>
                    <div class="niu2-sidebar-value">2015-07-01 00:00</div>
                    <div class="niu2-sidebar-label"><i class="icon-pencil"></i>category:</div>
                    <div class="niu2-sidebar-value"><a href="http://blog.dornea.nu/category/blog">blog</a></div>
                    <div class="niu2-sidebar-label"><i class="icon-tag"></i>Tag:</div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/ipython/">ipython</a><sup>16</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/hacking/">hacking</a><sup>22</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/security/">security</a><sup>35</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/android/">android</a><sup>26</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/python/">python</a><sup>25</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/mobile/">mobile</a><sup>11</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/appsec/">appsec</a><sup>25</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/eclipse/">eclipse</a><sup>3</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/c/">c</a><sup>8</sup></div>
                    <div class="niu2-sidebar-inter-value niu2-sidebar-tag"><a href="http://blog.dornea.nu/tag/gdb/">gdb</a><sup>1</sup></div>
                </div>

                <div id="niu2-sidebar-toc" class="niu2-sidebar" data-status="closed">
                    <div class="niu2-sidebar-label">
                        <i id="niu2-sidebar-toc-ctrl" class="icon-open-tocs"></i>Table of contents
                    </div>
                    <ul id="niu2-sidebar-toc-list">
                        <li><a href="#content-heading">Debugging Android native shared libraries</a></li>
                        <li><a href='#5a73c3a04b1cadec1079dd6a320ce367'>Create Eclipse project¶</a></li><li><a href='#3db753280a88ebe0a48885a81095a17d'>Create Android project¶</a></li><li><a href='#8742c5f749ad86585a6730c9a295d83f'>Add JNI functionalities¶</a><ul><li><a href='#60f24e461e47e35a67c1646440b1517d'>C header¶</a></li><li><a href='#befb599f3c079222c08ed59961472c1c'>C source¶</a></li><li><a href='#3167ee0d828bb1864e420e8e255aea2e'>Build the library¶</a></li></ul></li><li><a href='#76919fe41c886cd94adabaf467a6c722'>Call the library¶</a></li><li><a href='#4c061f922fcf6cd1d715b6f8672e4408'>Run the demo application¶</a></li><li><a href='#8a41ffef1d93ae9488256f7a78aa47be'>Debug the application¶</a><ul><li><a href='#c42d5ee5a38a904c5b25b4cf5b5eb955'>Remount /system as rw¶</a></li><li><a href='#eefbac16c9d82bad4406d3d902964a0d'>Copy gdbserver to device¶</a></li><li><a href='#bd344e0d8803fe6797cd0e80cc5639ad'>Copy ARM libraries to your client¶</a></li><li><a href='#c05250ac6ed45919e7c8c882e3669410'>Run the application¶</a></li><li><a href='#97ff27fb42962b1b0f4eef4e46138ab4'>Attach gdb to process¶</a></li><li><a href='#eaae69963118347f34db7ec3d2c2d0d9'>Read debugging information</a></li><li><a href='#cd6f71941cbbe02f9a60b4ff7a043aa4'>Find target function¶</a></li><li><a href='#71b688fd082c180add0772dae6917606'>Trigger and debug function¶</a></li></ul></li><li><a href='#5cd6478416b226b632eb44888361e8d8'>References¶</a></li>
                        <li><a href="#content-comments">Comments</a></li>
                    </ul>
                </div>
            </div>
            <div id="niu2-toolbar">
                <ul class="list-unstyled">
                    <li><a id="niu2-toolbar-ctrlsidebar" href="#" title="Hide Sidebar"><i class="icon-3x icon-hide-sidebar"></i></a></li>
                </ul>
                <div id="niu2-toolbar-showsidebar" data-title="Show Sidebar"></div>
                <div id="niu2-toolbar-github" data-repo=""></div>
                <div id="niu2-toolbar-bitbucket" data-repo=""></div>
            </div>
            <div id="niu2-toc" data-style="fixed"></div>
        </div>

        <div class="niu2-footer">
            <div id="body-footer" class="col-md-6 col-md-offset-2">
                <hr/>
                <p>
                    Powered by <a href="https://github.com/getpelican/pelican">Pelican</a>, 
                    <a href="https://github.com/mawenbao/niu-x2-sidebar">theme</a> built with <a href="https://github.com/twbs/bootstrap">Bootstrap3</a>
                    by <a href="https://blog.mawenbao.com">Ma Wenbao</a>, icons by 
                    <a href="https://fortawesome.github.io/Font-Awesome">Font Awesome</a>.
                </p>
                <p>
                    © 2008 - 2016
                    <a class="niu2-footer-link" href="http://blog.dornea.nu">Victor Dorneanu</a>
                </p>
                <p class="niu2-icons">
                    <a class="niu2-footer-icon" href="https://pgp.mit.edu/pks/lookup?op=get&search=0x18F1AD46FB05E1B7" title="my public key">
                        <i class="icon-key icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="mailto: no-spam ÄATT dornea DOT nu" title="my email address">
                        <i class="icon-envelope-o icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="http://github.com/dorneanu" title="my github page">
                        <i class="icon-github-alt icon-lg"></i>
                    </a>
                    <a class="niu2-footer-icon" href="/feeds/rss.xml" title="subscribe my blog">
                        <i class="icon-rss icon-lg"></i>
                    </a>
                </p>
            </div>
        </div>

        <script type="text/javascript">
            var _gaq=_gaq||[];
            _gaq.push(["_setAccount","UA-7161767-3"]);
            _gaq.push(["_trackPageview"]);
            (function(){
                var b=document.createElement("script");
                b.type="text/javascript";
                b.async=true;
                b.src=("https:"==document.location.protocol?"https://ssl":"http://www")+".google-analytics.com/ga.js";
                var a=document.getElementsByTagName("script")[0];
                a.parentNode.insertBefore(b,a)
            })();
        </script>
        <div id="niu2-pygments" data-theme="github"></div>
        <div id="niu2-lazy-load" data-loading-txt="Loading image" data-loading-icon="icon-spin icon-spinner"></div>
        <div id="niu2-toolbar-load" data-loading-icon="icon-spin icon-4x icon-spinner"></div>
        <script type="text/javascript" src="/js/custom.js"></script>
        <script type="text/javascript">
            onContentLoaded();
        </script>
    </body>
</html>